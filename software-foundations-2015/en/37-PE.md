<div id="page">

<div id="header">

</div>

<div id="main">

PE<span class="subtitle">Partial Evaluation</span> {.libtitle}
==================================================

<div class="code code-tight">

</div>

<div class="doc">

</div>

<div class="code code-tight">

\
 <span
class="comment">(\* Chapter author/maintainer: Chung-chieh Shan \*)</span>\
\

</div>

<div class="doc">

Equiv.v introduced constant folding as an example of a program
transformation and proved that it preserves the meaning of the program.
Constant folding operates on manifest constants such as <span
class="inlinecode"><span class="id" type="var">ANum</span></span>
expressions. For example, it simplifies the command <span
class="inlinecode"><span class="id" type="var">Y</span></span> <span
class="inlinecode">::=</span> <span class="inlinecode"><span class="id"
type="var">APlus</span></span> <span class="inlinecode">(<span
class="id" type="var">ANum</span></span> <span
class="inlinecode">3)</span> <span class="inlinecode">(<span class="id"
type="var">ANum</span></span> <span class="inlinecode">1)</span> to the
command <span class="inlinecode"><span class="id"
type="var">Y</span></span> <span class="inlinecode">::=</span> <span
class="inlinecode"><span class="id" type="var">ANum</span></span> <span
class="inlinecode">4</span>. However, it does not propagate known
constants along data flow. For example, it does not simplify the
sequence
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">Y</span> ::= <span class="id" type="var">APlus</span> (<span
class="id" type="var">AId</span> <span class="id"
type="var">X</span>) (<span class="id" type="var">ANum</span> 1)
<div class="paragraph">

</div>

</div>

to
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">Y</span> ::= <span class="id" type="var">ANum</span> 4
<div class="paragraph">

</div>

</div>

because it forgets that <span class="inlinecode"><span class="id"
type="var">X</span></span> is <span class="inlinecode">3</span> by the
time it gets to <span class="inlinecode"><span class="id"
type="var">Y</span></span>.
<div class="paragraph">

</div>

We naturally want to enhance constant folding so that it propagates
known constants and uses them to simplify programs. Doing so constitutes
a rudimentary form of *partial evaluation*. As we will see, partial
evaluation is so called because it is like running a program, except
only part of the program can be evaluated because only part of the input
to the program is known. For example, we can only simplify the program
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span
class="id" type="var">APlus</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">X</span>) (<span
class="id" type="var">ANum</span> 1)) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>)
<div class="paragraph">

</div>

</div>

to
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span
class="id" type="var">ANum</span> 4) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>)
<div class="paragraph">

</div>

</div>

without knowing the initial value of <span class="inlinecode"><span
class="id" type="var">Y</span></span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Require</span> <span class="id"
type="keyword">Export</span> <span class="id" type="var">Imp</span>.\
 <span class="id" type="keyword">Require</span> <span class="id"
type="keyword">Import</span> <span class="id"
type="var">FunctionalExtensionality</span>.\
\

</div>

<div class="doc">

Generalizing Constant Folding {.section}
=============================

<div class="paragraph">

</div>

The starting point of partial evaluation is to represent our partial
knowledge about the state. For example, between the two assignments
above, the partial evaluator may know only that <span
class="inlinecode"><span class="id" type="var">X</span></span> is <span
class="inlinecode">3</span> and nothing about any other variable.
<div class="paragraph">

</div>

Partial States {.section}
--------------

<div class="paragraph">

</div>

Conceptually speaking, we can think of such partial states as the type
<span class="inlinecode"><span class="id" type="var">id</span></span>
<span class="inlinecode"><span
style="font-family: arial;">→</span></span> <span
class="inlinecode"><span class="id" type="var">option</span></span>
<span class="inlinecode"><span class="id" type="var">nat</span></span>
(as opposed to the type <span class="inlinecode"><span class="id"
type="var">id</span></span> <span class="inlinecode"><span
style="font-family: arial;">→</span></span> <span
class="inlinecode"><span class="id" type="var">nat</span></span> of
concrete, full states). However, in addition to looking up and updating
the values of individual variables in a partial state, we may also want
to compare two partial states to see if and where they differ, to handle
conditional control flow. It is not possible to compare two arbitrary
functions in this way, so we represent partial states in a more concrete
format: as a list of <span class="inlinecode"><span class="id"
type="var">id</span></span> <span class="inlinecode">×</span> <span
class="inlinecode"><span class="id" type="var">nat</span></span> pairs.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">pe\_state</span> := <span class="id" type="var">list</span>
(<span class="id" type="var">id</span> × <span class="id"
type="var">nat</span>).\
\

</div>

<div class="doc">

The idea is that a variable <span class="inlinecode"><span class="id"
type="var">id</span></span> appears in the list if and only if we know
its current <span class="inlinecode"><span class="id"
type="var">nat</span></span> value. The <span class="inlinecode"><span
class="id" type="var">pe\_lookup</span></span> function thus interprets
this concrete representation. (If the same variable <span
class="inlinecode"><span class="id" type="var">id</span></span> appears
multiple times in the list, the first occurrence wins, but we will
define our partial evaluator to never construct such a <span
class="inlinecode"><span class="id" type="var">pe\_state</span></span>.)

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_lookup</span> (<span class="id" type="var">pe\_st</span>
: <span class="id" type="var">pe\_state</span>) (<span class="id"
type="var">V</span>:<span class="id" type="var">id</span>) : <span
class="id" type="var">option</span> <span class="id"
type="var">nat</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="keyword">with</span>\
   | [] ⇒ <span class="id" type="var">None</span>\
   | (<span class="id" type="var">V'</span>,<span class="id"
type="var">n'</span>)::<span class="id" type="var">pe\_st</span> ⇒ <span
class="id" type="keyword">if</span> <span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V'</span> <span class="id"
type="keyword">then</span> <span class="id" type="var">Some</span> <span
class="id" type="var">n'</span>\
                       <span class="id" type="keyword">else</span> <span
class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span>\
   <span class="id" type="keyword">end</span>.\
\

</div>

<div class="doc">

For example, <span class="inlinecode"><span class="id"
type="var">empty\_pe\_state</span></span> represents complete ignorance
about every variable — the function that maps every <span
class="inlinecode"><span class="id" type="var">id</span></span> to <span
class="inlinecode"><span class="id" type="var">None</span></span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">empty\_pe\_state</span> : <span class="id"
type="var">pe\_state</span> := [].\
\

</div>

<div class="doc">

More generally, if the <span class="inlinecode"><span class="id"
type="var">list</span></span> representing a <span
class="inlinecode"><span class="id" type="var">pe\_state</span></span>
does not contain some <span class="inlinecode"><span class="id"
type="var">id</span></span>, then that <span class="inlinecode"><span
class="id" type="var">pe\_state</span></span> must map that <span
class="inlinecode"><span class="id" type="var">id</span></span> to <span
class="inlinecode"><span class="id" type="var">None</span></span>.
Before we prove this fact, we first define a useful tactic for reasoning
with <span class="inlinecode"><span class="id"
type="var">id</span></span> equality. The tactic
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">compare</span> <span class="id"
type="var">V</span> <span class="id" type="var">V'</span> <span
class="id" type="var">SCase</span>
<div class="paragraph">

</div>

</div>

means to reason by cases over <span class="inlinecode"><span class="id"
type="var">eq\_id\_dec</span></span> <span class="inlinecode"><span
class="id" type="var">V</span></span> <span class="inlinecode"><span
class="id" type="var">V'</span></span>. In the case where <span
class="inlinecode"><span class="id" type="var">V</span></span> <span
class="inlinecode">=</span> <span class="inlinecode"><span class="id"
type="var">V'</span></span>, the tactic substitutes <span
class="inlinecode"><span class="id" type="var">V</span></span> for <span
class="inlinecode"><span class="id" type="var">V'</span></span>
throughout.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Tactic Notation</span> "compare" <span
class="id" type="var">ident</span>(<span class="id" type="var">i</span>)
<span class="id" type="var">ident</span>(<span class="id"
type="var">j</span>) <span class="id" type="var">ident</span>(<span
class="id" type="var">c</span>) :=\
   <span class="id" type="keyword">let</span> <span class="id"
type="var">H</span> := <span class="id" type="tactic">fresh</span> "Heq"
<span class="id" type="var">i</span> <span class="id"
type="var">j</span> <span class="id" type="keyword">in</span>\
   <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">i</span> <span
class="id" type="var">j</span>);\
   [ <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "equal"; <span class="id" type="tactic">subst</span>
<span class="id" type="var">j</span>\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "not equal" ].\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_domain</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span> <span
class="id" type="var">n</span>,\
   <span class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span> = <span
class="id" type="var">Some</span> <span class="id" type="var">n</span>
<span style="font-family: arial;">→</span>\
   <span class="id" type="var">In</span> <span class="id"
type="var">V</span> (<span class="id" type="var">map</span> (@<span
class="id" type="var">fst</span> <span class="id" type="var">\_</span>
<span class="id" type="var">\_</span>) <span class="id"
type="var">pe\_st</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span> <span class="id"
type="var">n</span> <span class="id" type="var">H</span>. <span
class="id" type="tactic">induction</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="keyword">as</span> [|
[<span class="id" type="var">V'</span> <span class="id"
type="var">n'</span>] <span class="id" type="var">pe\_st</span>].\
   <span class="id" type="var">Case</span> "[]". <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>.\
   <span class="id" type="var">Case</span> "::". <span class="id"
type="tactic">simpl</span> <span class="id" type="keyword">in</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">simpl</span>. <span class="id" type="var">compare</span>
<span class="id" type="var">V</span> <span class="id"
type="var">V'</span> <span class="id" type="var">SCase</span>; <span
class="id" type="tactic">auto</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

### Aside on <span class="inlinecode"><span class="id" type="var">In</span></span>. {.section}

<div class="paragraph">

</div>

We will make heavy use of the <span class="inlinecode"><span class="id"
type="var">In</span></span> predicate from the standard library. <span
class="inlinecode"><span class="id" type="var">In</span></span> is
equivalent to the <span class="inlinecode"><span class="id"
type="var">appears\_in</span></span> predicate introduced in Logic.v,
but defined using a <span class="inlinecode"><span class="id"
type="keyword">Fixpoint</span></span> rather than an <span
class="inlinecode"><span class="id"
type="keyword">Inductive</span></span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Print</span> <span class="id"
type="var">In</span>.\
 <span
class="comment">(\* ===\> Fixpoint In {A:Type} (a: A) (l:list A) : Prop :=\
            match l with\
            | <span class="inlinecode"></span> =\> False\
            | b :: m =\> b = a \\/ In a m\
             end\
         : forall A : Type, A -\> list A -\> Prop \*)</span>\
\

</div>

<div class="doc">

<span class="inlinecode"><span class="id" type="var">In</span></span>
comes with various useful lemmas.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Check</span> <span class="id"
type="var">in\_or\_app</span>.\
 <span
class="comment">(\* ===\>  in\_or\_app: forall (A : Type) (l m : list A) (a : A), \
                 In a l \\/ In a m -\> In a (l ++ m) \*)</span>\
\
 <span class="id" type="keyword">Check</span> <span class="id"
type="var">filter\_In</span>.\
 <span
class="comment">(\* ===\> filter\_In : forall (A : Type) (f : A -\> bool) (x : A) (l : list A),\

                 In x (filter f l) \<-\> In x l /\\ f x = true  \*)</span>\
\
 <span class="id" type="keyword">Check</span> <span class="id"
type="var">in\_dec</span>.\
 <span class="comment">(\* ===\> in\_dec : forall A : Type,\
              (forall x y : A, {x = y} + {x \<\> y}) -\>\

             forall (a : A) (l : list A), {In a l} + {\~ In a l}] \*)</span>\
\

</div>

<div class="doc">

Note that we can compute with <span class="inlinecode"><span class="id"
type="var">in\_dec</span></span>, just as with <span
class="inlinecode"><span class="id"
type="var">eq\_id\_dec</span></span>.
<div class="paragraph">

</div>

Arithmetic Expressions {.section}
----------------------

<div class="paragraph">

</div>

Partial evaluation of <span class="inlinecode"><span class="id"
type="var">aexp</span></span> is straightforward — it is basically the
same as constant folding, <span class="inlinecode"><span class="id"
type="var">fold\_constants\_aexp</span></span>, except that sometimes
the partial state tells us the current value of a variable and we can
replace it by a constant expression.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_aexp</span> (<span class="id" type="var">pe\_st</span> :
<span class="id" type="var">pe\_state</span>) (<span class="id"
type="var">a</span> : <span class="id" type="var">aexp</span>) : <span
class="id" type="var">aexp</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">a</span> <span class="id" type="keyword">with</span>\
   | <span class="id" type="var">ANum</span> <span class="id"
type="var">n</span> ⇒ <span class="id" type="var">ANum</span> <span
class="id" type="var">n</span>\
   | <span class="id" type="var">AId</span> <span class="id"
type="var">i</span> ⇒ <span class="id" type="keyword">match</span> <span
class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">i</span> <span
class="id" type="keyword">with</span> <span
class="comment">(\* \<----- NEW \*)</span>\
              | <span class="id" type="var">Some</span> <span class="id"
type="var">n</span> ⇒ <span class="id" type="var">ANum</span> <span
class="id" type="var">n</span>\
              | <span class="id" type="var">None</span> ⇒ <span
class="id" type="var">AId</span> <span class="id" type="var">i</span>\
              <span class="id" type="keyword">end</span>\
   | <span class="id" type="var">APlus</span> <span class="id"
type="var">a1</span> <span class="id" type="var">a2</span> ⇒\
       <span class="id" type="keyword">match</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a1</span>, <span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a2</span>) <span class="id"
type="keyword">with</span>\
       | (<span class="id" type="var">ANum</span> <span class="id"
type="var">n1</span>, <span class="id" type="var">ANum</span> <span
class="id" type="var">n2</span>) ⇒ <span class="id"
type="var">ANum</span> (<span class="id" type="var">n1</span> + <span
class="id" type="var">n2</span>)\
       | (<span class="id" type="var">a1'</span>, <span class="id"
type="var">a2'</span>) ⇒ <span class="id" type="var">APlus</span> <span
class="id" type="var">a1'</span> <span class="id" type="var">a2'</span>\
       <span class="id" type="keyword">end</span>\
   | <span class="id" type="var">AMinus</span> <span class="id"
type="var">a1</span> <span class="id" type="var">a2</span> ⇒\
       <span class="id" type="keyword">match</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a1</span>, <span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a2</span>) <span class="id"
type="keyword">with</span>\
       | (<span class="id" type="var">ANum</span> <span class="id"
type="var">n1</span>, <span class="id" type="var">ANum</span> <span
class="id" type="var">n2</span>) ⇒ <span class="id"
type="var">ANum</span> (<span class="id" type="var">n1</span> - <span
class="id" type="var">n2</span>)\
       | (<span class="id" type="var">a1'</span>, <span class="id"
type="var">a2'</span>) ⇒ <span class="id" type="var">AMinus</span> <span
class="id" type="var">a1'</span> <span class="id" type="var">a2'</span>\
       <span class="id" type="keyword">end</span>\
   | <span class="id" type="var">AMult</span> <span class="id"
type="var">a1</span> <span class="id" type="var">a2</span> ⇒\
       <span class="id" type="keyword">match</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a1</span>, <span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a2</span>) <span class="id"
type="keyword">with</span>\
       | (<span class="id" type="var">ANum</span> <span class="id"
type="var">n1</span>, <span class="id" type="var">ANum</span> <span
class="id" type="var">n2</span>) ⇒ <span class="id"
type="var">ANum</span> (<span class="id" type="var">n1</span> × <span
class="id" type="var">n2</span>)\
       | (<span class="id" type="var">a1'</span>, <span class="id"
type="var">a2'</span>) ⇒ <span class="id" type="var">AMult</span> <span
class="id" type="var">a1'</span> <span class="id" type="var">a2'</span>\
       <span class="id" type="keyword">end</span>\
   <span class="id" type="keyword">end</span>.\
\

</div>

<div class="doc">

This partial evaluator folds constants but does not apply the
associativity of addition.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">test\_pe\_aexp1</span>:\
   <span class="id" type="var">pe\_aexp</span> [(<span class="id"
type="var">X</span>,3)] (<span class="id" type="var">APlus</span> (<span
class="id" type="var">APlus</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">X</span>) (<span
class="id" type="var">ANum</span> 1)) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>))\
   = <span class="id" type="var">APlus</span> (<span class="id"
type="var">ANum</span> 4) (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">text\_pe\_aexp2</span>:\
   <span class="id" type="var">pe\_aexp</span> [(<span class="id"
type="var">Y</span>,3)] (<span class="id" type="var">APlus</span> (<span
class="id" type="var">APlus</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">X</span>) (<span
class="id" type="var">ANum</span> 1)) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>))\
   = <span class="id" type="var">APlus</span> (<span class="id"
type="var">APlus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id" type="var">ANum</span>
1)) (<span class="id" type="var">ANum</span> 3).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Now, in what sense is <span class="inlinecode"><span class="id"
type="var">pe\_aexp</span></span> correct? It is reasonable to define
the correctness of <span class="inlinecode"><span class="id"
type="var">pe\_aexp</span></span> as follows: whenever a full state
<span class="inlinecode"><span class="id" type="var">st</span>:<span
class="id" type="var">state</span></span> is *consistent* with a partial
state <span class="inlinecode"><span class="id"
type="var">pe\_st</span>:<span class="id"
type="var">pe\_state</span></span> (in other words, every variable to
which <span class="inlinecode"><span class="id"
type="var">pe\_st</span></span> assigns a value is assigned the same
value by <span class="inlinecode"><span class="id"
type="var">st</span></span>), evaluating <span class="inlinecode"><span
class="id" type="var">a</span></span> and evaluating <span
class="inlinecode"><span class="id" type="var">pe\_aexp</span></span>
<span class="inlinecode"><span class="id"
type="var">pe\_st</span></span> <span class="inlinecode"><span
class="id" type="var">a</span></span> in <span class="inlinecode"><span
class="id" type="var">st</span></span> yields the same result. This
statement is indeed true.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">pe\_consistent</span> (<span class="id"
type="var">st</span>:<span class="id" type="var">state</span>) (<span
class="id" type="var">pe\_st</span>:<span class="id"
type="var">pe\_state</span>) :=\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">V</span> <span class="id" type="var">n</span>, <span
class="id" type="var">Some</span> <span class="id" type="var">n</span> =
<span class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">st</span> <span class="id" type="var">V</span> = <span
class="id" type="var">n</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_aexp\_correct\_weak</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span>, <span
class="id" type="var">pe\_consistent</span> <span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">a</span>, <span class="id" type="var">aeval</span> <span
class="id" type="var">st</span> <span class="id" type="var">a</span> =
<span class="id" type="var">aeval</span> <span class="id"
type="var">st</span> (<span class="id" type="var">pe\_aexp</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">a</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">unfold</span> <span class="id"
type="var">pe\_consistent</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">H</span>
<span class="id" type="var">a</span>.\
   <span class="id" type="var">aexp\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">a</span>)
<span class="id" type="var">Case</span>; <span class="id"
type="tactic">simpl</span>;\
     <span class="id" type="tactic">try</span> <span class="id"
type="tactic">reflexivity</span>;\
     <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a1</span>);\
          <span class="id" type="tactic">destruct</span> (<span
class="id" type="var">pe\_aexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">a2</span>);\
          <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">IHa1</span>; <span class="id" type="tactic">rewrite</span>
<span class="id" type="var">IHa2</span>; <span class="id"
type="tactic">reflexivity</span>).\
   <span class="comment">(\* Compared to fold\_constants\_aexp\_sound,\
      the only interesting case is AId \*)</span>\
   <span class="id" type="var">Case</span> "AId".\
     <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">i</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">l</span>. <span
class="id" type="tactic">destruct</span> <span class="id"
type="var">l</span>.\
     <span class="id" type="var">SCase</span> "Some". <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">H</span> <span
class="id" type="keyword">with</span> (<span class="id"
type="var">n</span>:=<span class="id" type="var">n</span>) <span
class="id" type="tactic">by</span> <span class="id"
type="tactic">apply</span> <span class="id" type="var">Heql</span>.
<span class="id" type="tactic">reflexivity</span>.\
     <span class="id" type="var">SCase</span> "None". <span class="id"
type="tactic">reflexivity</span>.\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

However, we will soon want our partial evaluator to remove assignments.
For example, it will simplify
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span
class="id" type="var">AId</span> <span class="id"
type="var">X</span>) (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>);; <span class="id"
type="var">X</span> ::= <span class="id" type="var">ANum</span> 4
<div class="paragraph">

</div>

</div>

to just
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id"
type="var">ANum</span> 3) (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>);; <span class="id"
type="var">X</span> ::= <span class="id" type="var">ANum</span> 4
<div class="paragraph">

</div>

</div>

by delaying the assignment to <span class="inlinecode"><span class="id"
type="var">X</span></span> until the end. To accomplish this
simplification, we need the result of partial evaluating
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">pe\_aexp</span> [(<span class="id"
type="var">X</span>,3)] (<span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>))
<div class="paragraph">

</div>

</div>

to be equal to <span class="inlinecode"><span class="id"
type="var">AMinus</span></span> <span class="inlinecode">(<span
class="id" type="var">ANum</span></span> <span
class="inlinecode">3)</span> <span class="inlinecode">(<span class="id"
type="var">AId</span></span> <span class="inlinecode"><span class="id"
type="var">Y</span>)</span> and *not* the original expression <span
class="inlinecode"><span class="id" type="var">AMinus</span></span>
<span class="inlinecode">(<span class="id" type="var">AId</span></span>
<span class="inlinecode"><span class="id" type="var">X</span>)</span>
<span class="inlinecode">(<span class="id" type="var">AId</span></span>
<span class="inlinecode"><span class="id" type="var">Y</span>)</span>.
After all, it would be incorrect, not just inefficient, to transform
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">Y</span> ::= <span class="id" type="var">AMinus</span> (<span
class="id" type="var">AId</span> <span class="id"
type="var">X</span>) (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>);; <span class="id"
type="var">X</span> ::= <span class="id" type="var">ANum</span> 4
<div class="paragraph">

</div>

</div>

to
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>);; <span
class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 4
<div class="paragraph">

</div>

</div>

even though the output expressions <span class="inlinecode"><span
class="id" type="var">AMinus</span></span> <span
class="inlinecode">(<span class="id" type="var">ANum</span></span> <span
class="inlinecode">3)</span> <span class="inlinecode">(<span class="id"
type="var">AId</span></span> <span class="inlinecode"><span class="id"
type="var">Y</span>)</span> and <span class="inlinecode"><span
class="id" type="var">AMinus</span></span> <span
class="inlinecode">(<span class="id" type="var">AId</span></span> <span
class="inlinecode"><span class="id" type="var">X</span>)</span> <span
class="inlinecode">(<span class="id" type="var">AId</span></span> <span
class="inlinecode"><span class="id" type="var">Y</span>)</span> both
satisfy the correctness criterion that we just proved. Indeed, if we
were to just define <span class="inlinecode"><span class="id"
type="var">pe\_aexp</span></span> <span class="inlinecode"><span
class="id" type="var">pe\_st</span></span> <span
class="inlinecode"><span class="id" type="var">a</span></span> <span
class="inlinecode">=</span> <span class="inlinecode"><span class="id"
type="var">a</span></span> then the theorem <span
class="inlinecode"><span class="id"
type="var">pe\_aexp\_correct'</span></span> would already trivially
hold.
<div class="paragraph">

</div>

Instead, we want to prove that the <span class="inlinecode"><span
class="id" type="var">pe\_aexp</span></span> is correct in a stronger
sense: evaluating the expression produced by partial evaluation (<span
class="inlinecode"><span class="id" type="var">aeval</span></span> <span
class="inlinecode"><span class="id" type="var">st</span></span> <span
class="inlinecode">(<span class="id" type="var">pe\_aexp</span></span>
<span class="inlinecode"><span class="id"
type="var">pe\_st</span></span> <span class="inlinecode"><span
class="id" type="var">a</span>)</span>) must not depend on those parts
of the full state <span class="inlinecode"><span class="id"
type="var">st</span></span> that are already specified in the partial
state <span class="inlinecode"><span class="id"
type="var">pe\_st</span></span>. To be more precise, let us define a
function <span class="inlinecode"><span class="id"
type="var">pe\_override</span></span>, which updates <span
class="inlinecode"><span class="id" type="var">st</span></span> with the
contents of <span class="inlinecode"><span class="id"
type="var">pe\_st</span></span>. In other words, <span
class="inlinecode"><span class="id"
type="var">pe\_override</span></span> carries out the assignments listed
in <span class="inlinecode"><span class="id"
type="var">pe\_st</span></span> on top of <span class="inlinecode"><span
class="id" type="var">st</span></span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_override</span> (<span class="id"
type="var">st</span>:<span class="id" type="var">state</span>) (<span
class="id" type="var">pe\_st</span>:<span class="id"
type="var">pe\_state</span>) : <span class="id" type="var">state</span>
:=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="keyword">with</span>\
   | [] ⇒ <span class="id" type="var">st</span>\
   | (<span class="id" type="var">V</span>,<span class="id"
type="var">n</span>)::<span class="id" type="var">pe\_st</span> ⇒ <span
class="id" type="var">update</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="var">V</span> <span class="id" type="var">n</span>\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">test\_pe\_override</span>:\
   <span class="id" type="var">pe\_override</span> (<span class="id"
type="var">update</span> <span class="id" type="var">empty\_state</span>
<span class="id" type="var">Y</span> 1) [(<span class="id"
type="var">X</span>,3);(<span class="id" type="var">Z</span>,2)]\
   = <span class="id" type="var">update</span> (<span class="id"
type="var">update</span> (<span class="id" type="var">update</span>
<span class="id" type="var">empty\_state</span> <span class="id"
type="var">Y</span> 1) <span class="id" type="var">Z</span> 2) <span
class="id" type="var">X</span> 3.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Although <span class="inlinecode"><span class="id"
type="var">pe\_override</span></span> operates on a concrete <span
class="inlinecode"><span class="id" type="var">list</span></span>
representing a <span class="inlinecode"><span class="id"
type="var">pe\_state</span></span>, its behavior is defined entirely by
the <span class="inlinecode"><span class="id"
type="var">pe\_lookup</span></span> interpretation of the <span
class="inlinecode"><span class="id" type="var">pe\_state</span></span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_override\_correct</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">V0</span>,\
   <span class="id" type="var">pe\_override</span> <span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">V0</span> =\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V0</span> <span class="id"
type="keyword">with</span>\
   | <span class="id" type="var">Some</span> <span class="id"
type="var">n</span> ⇒ <span class="id" type="var">n</span>\
   | <span class="id" type="var">None</span> ⇒ <span class="id"
type="var">st</span> <span class="id" type="var">V0</span>\
   <span class="id" type="keyword">end</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span>. <span class="id"
type="tactic">induction</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="keyword">as</span> [| [<span class="id"
type="var">V</span> <span class="id" type="var">n</span>] <span
class="id" type="var">pe\_st</span>]. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">simpl</span> <span class="id"
type="keyword">in</span> ×. <span class="id" type="tactic">unfold</span>
<span class="id" type="var">update</span>.\
   <span class="id" type="var">compare</span> <span class="id"
type="var">V0</span> <span class="id" type="var">V</span> <span
class="id" type="var">Case</span>; <span class="id"
type="tactic">auto</span>. <span class="id" type="tactic">rewrite</span>
<span class="id" type="var">eq\_id</span>; <span class="id"
type="tactic">auto</span>. <span class="id" type="tactic">rewrite</span>
<span class="id" type="var">neq\_id</span>; <span class="id"
type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

We can relate <span class="inlinecode"><span class="id"
type="var">pe\_consistent</span></span> to <span
class="inlinecode"><span class="id"
type="var">pe\_override</span></span> in two ways. First, overriding a
state with a partial state always gives a state that is consistent with
the partial state. Second, if a state is already consistent with a
partial state, then overriding the state with the partial state gives
the same state.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_override\_consistent</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span>,\
   <span class="id" type="var">pe\_consistent</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="var">pe\_st</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">V</span>
<span class="id" type="var">n</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">rewrite</span> <span
class="id" type="var">pe\_override\_correct</span>.\
   <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span>); <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>.
<span class="id" type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_consistent\_override</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span>,\
   <span class="id" type="var">pe\_consistent</span> <span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">→</span> <span
style="font-family: arial;">∀</span><span class="id"
type="var">V</span>, <span class="id" type="var">st</span> <span
class="id" type="var">V</span> = <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">V</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">H</span>
<span class="id" type="var">V</span>. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_override\_correct</span>.\
   <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">l</span>. <span
class="id" type="tactic">destruct</span> <span class="id"
type="var">l</span>; <span class="id" type="tactic">auto</span>. <span
class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Now we can state and prove that <span class="inlinecode"><span
class="id" type="var">pe\_aexp</span></span> is correct in the stronger
sense that will help us define the rest of the partial evaluator.
<div class="paragraph">

</div>

Intuitively, running a program using partial evaluation is a two-stage
process. In the first, *static* stage, we partially evaluate the given
program with respect to some partial state to get a *residual* program.
In the second, *dynamic* stage, we evaluate the residual program with
respect to the rest of the state. This dynamic state provides values for
those variables that are unknown in the static (partial) state. Thus,
the residual program should be equivalent to *prepending* the
assignments listed in the partial state to the original program.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_aexp\_correct</span>: <span
style="font-family: arial;">∀</span>(<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">a</span>:<span class="id"
type="var">aexp</span>) (<span class="id" type="var">st</span>:<span
class="id" type="var">state</span>),\
   <span class="id" type="var">aeval</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="var">a</span> = <span class="id" type="var">aeval</span> <span
class="id" type="var">st</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a</span>).\
 <span class="id" type="keyword">Proof</span>.\
   <span class="id" type="tactic">intros</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">a</span> <span
class="id" type="var">st</span>.\
   <span class="id" type="var">aexp\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">a</span>)
<span class="id" type="var">Case</span>; <span class="id"
type="tactic">simpl</span>;\
     <span class="id" type="tactic">try</span> <span class="id"
type="tactic">reflexivity</span>;\
     <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a1</span>);\
          <span class="id" type="tactic">destruct</span> (<span
class="id" type="var">pe\_aexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">a2</span>);\
          <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">IHa1</span>; <span class="id" type="tactic">rewrite</span>
<span class="id" type="var">IHa2</span>; <span class="id"
type="tactic">reflexivity</span>).\
   <span
class="comment">(\* Compared to fold\_constants\_aexp\_sound, the only \
      interesting case is AId. \*)</span>\
   <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">pe\_override\_correct</span>. <span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">i</span>); <span class="id"
type="tactic">reflexivity</span>.\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Boolean Expressions {.section}
-------------------

<div class="paragraph">

</div>

The partial evaluation of boolean expressions is similar. In fact, it is
entirely analogous to the constant folding of boolean expressions,
because our language has no boolean variables.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_bexp</span> (<span class="id" type="var">pe\_st</span> :
<span class="id" type="var">pe\_state</span>) (<span class="id"
type="var">b</span> : <span class="id" type="var">bexp</span>) : <span
class="id" type="var">bexp</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">b</span> <span class="id" type="keyword">with</span>\
   | <span class="id" type="var">BTrue</span> ⇒ <span class="id"
type="var">BTrue</span>\
   | <span class="id" type="var">BFalse</span> ⇒ <span class="id"
type="var">BFalse</span>\
   | <span class="id" type="var">BEq</span> <span class="id"
type="var">a1</span> <span class="id" type="var">a2</span> ⇒\
       <span class="id" type="keyword">match</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a1</span>, <span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a2</span>) <span class="id"
type="keyword">with</span>\
       | (<span class="id" type="var">ANum</span> <span class="id"
type="var">n1</span>, <span class="id" type="var">ANum</span> <span
class="id" type="var">n2</span>) ⇒ <span class="id"
type="keyword">if</span> <span class="id" type="var">beq\_nat</span>
<span class="id" type="var">n1</span> <span class="id"
type="var">n2</span> <span class="id" type="keyword">then</span> <span
class="id" type="var">BTrue</span> <span class="id"
type="keyword">else</span> <span class="id" type="var">BFalse</span>\
       | (<span class="id" type="var">a1'</span>, <span class="id"
type="var">a2'</span>) ⇒ <span class="id" type="var">BEq</span> <span
class="id" type="var">a1'</span> <span class="id" type="var">a2'</span>\
       <span class="id" type="keyword">end</span>\
   | <span class="id" type="var">BLe</span> <span class="id"
type="var">a1</span> <span class="id" type="var">a2</span> ⇒\
       <span class="id" type="keyword">match</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a1</span>, <span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a2</span>) <span class="id"
type="keyword">with</span>\
       | (<span class="id" type="var">ANum</span> <span class="id"
type="var">n1</span>, <span class="id" type="var">ANum</span> <span
class="id" type="var">n2</span>) ⇒ <span class="id"
type="keyword">if</span> <span class="id" type="var">ble\_nat</span>
<span class="id" type="var">n1</span> <span class="id"
type="var">n2</span> <span class="id" type="keyword">then</span> <span
class="id" type="var">BTrue</span> <span class="id"
type="keyword">else</span> <span class="id" type="var">BFalse</span>\
       | (<span class="id" type="var">a1'</span>, <span class="id"
type="var">a2'</span>) ⇒ <span class="id" type="var">BLe</span> <span
class="id" type="var">a1'</span> <span class="id" type="var">a2'</span>\
       <span class="id" type="keyword">end</span>\
   | <span class="id" type="var">BNot</span> <span class="id"
type="var">b1</span> ⇒\
       <span class="id" type="keyword">match</span> (<span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b1</span>) <span class="id"
type="keyword">with</span>\
       | <span class="id" type="var">BTrue</span> ⇒ <span class="id"
type="var">BFalse</span>\
       | <span class="id" type="var">BFalse</span> ⇒ <span class="id"
type="var">BTrue</span>\
       | <span class="id" type="var">b1'</span> ⇒ <span class="id"
type="var">BNot</span> <span class="id" type="var">b1'</span>\
       <span class="id" type="keyword">end</span>\
   | <span class="id" type="var">BAnd</span> <span class="id"
type="var">b1</span> <span class="id" type="var">b2</span> ⇒\
       <span class="id" type="keyword">match</span> (<span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b1</span>, <span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b2</span>) <span class="id"
type="keyword">with</span>\
       | (<span class="id" type="var">BTrue</span>, <span class="id"
type="var">BTrue</span>) ⇒ <span class="id" type="var">BTrue</span>\
       | (<span class="id" type="var">BTrue</span>, <span class="id"
type="var">BFalse</span>) ⇒ <span class="id" type="var">BFalse</span>\
       | (<span class="id" type="var">BFalse</span>, <span class="id"
type="var">BTrue</span>) ⇒ <span class="id" type="var">BFalse</span>\
       | (<span class="id" type="var">BFalse</span>, <span class="id"
type="var">BFalse</span>) ⇒ <span class="id" type="var">BFalse</span>\
       | (<span class="id" type="var">b1'</span>, <span class="id"
type="var">b2'</span>) ⇒ <span class="id" type="var">BAnd</span> <span
class="id" type="var">b1'</span> <span class="id" type="var">b2'</span>\
       <span class="id" type="keyword">end</span>\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">test\_pe\_bexp1</span>:\
   <span class="id" type="var">pe\_bexp</span> [(<span class="id"
type="var">X</span>,3)] (<span class="id" type="var">BNot</span> (<span
class="id" type="var">BLe</span> (<span class="id" type="var">AId</span>
<span class="id" type="var">X</span>) (<span class="id"
type="var">ANum</span> 3)))\
   = <span class="id" type="var">BFalse</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">test\_pe\_bexp2</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">b</span>,\
   <span class="id" type="var">b</span> = <span class="id"
type="var">BNot</span> (<span class="id" type="var">BLe</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
(<span class="id" type="var">APlus</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">X</span>) (<span
class="id" type="var">ANum</span> 1))) <span
style="font-family: arial;">→</span>\
   <span class="id" type="var">pe\_bexp</span> [] <span class="id"
type="var">b</span> = <span class="id" type="var">b</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">b</span> <span
class="id" type="var">H</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

The correctness of <span class="inlinecode"><span class="id"
type="var">pe\_bexp</span></span> is analogous to the correctness of
<span class="inlinecode"><span class="id"
type="var">pe\_aexp</span></span> above.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_bexp\_correct</span>: <span
style="font-family: arial;">∀</span>(<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">b</span>:<span class="id"
type="var">bexp</span>) (<span class="id" type="var">st</span>:<span
class="id" type="var">state</span>),\
   <span class="id" type="var">beval</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="var">b</span> = <span class="id" type="var">beval</span> <span
class="id" type="var">st</span> (<span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b</span>).\
 <span class="id" type="keyword">Proof</span>.\
   <span class="id" type="tactic">intros</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b</span> <span
class="id" type="var">st</span>.\
   <span class="id" type="var">bexp\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">b</span>)
<span class="id" type="var">Case</span>; <span class="id"
type="tactic">simpl</span>;\
     <span class="id" type="tactic">try</span> <span class="id"
type="tactic">reflexivity</span>;\
     <span class="id" type="tactic">try</span> (<span class="id"
type="var">remember</span> (<span class="id" type="var">pe\_aexp</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">a</span>) <span class="id" type="keyword">as</span> <span
class="id" type="var">a'</span>;\
          <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a0</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">a0'</span>;\
          <span class="id" type="tactic">assert</span> (<span class="id"
type="var">Ha</span>: <span class="id" type="var">aeval</span> (<span
class="id" type="var">pe\_override</span> <span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span>) <span
class="id" type="var">a</span> = <span class="id"
type="var">aeval</span> <span class="id" type="var">st</span> <span
class="id" type="var">a'</span>);\
          <span class="id" type="tactic">assert</span> (<span class="id"
type="var">Ha0</span>: <span class="id" type="var">aeval</span> (<span
class="id" type="var">pe\_override</span> <span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span>) <span
class="id" type="var">a0</span> = <span class="id"
type="var">aeval</span> <span class="id" type="var">st</span> <span
class="id" type="var">a0'</span>);\
            <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">subst</span>; <span class="id" type="tactic">apply</span>
<span class="id" type="var">pe\_aexp\_correct</span>);\
          <span class="id" type="tactic">destruct</span> <span
class="id" type="var">a'</span>; <span class="id"
type="tactic">destruct</span> <span class="id" type="var">a0'</span>;
<span class="id" type="tactic">rewrite</span> <span class="id"
type="var">Ha</span>; <span class="id" type="tactic">rewrite</span>
<span class="id" type="var">Ha0</span>;\
          <span class="id" type="tactic">simpl</span>; <span class="id"
type="tactic">try</span> <span class="id" type="tactic">destruct</span>
(<span class="id" type="var">beq\_nat</span> <span class="id"
type="var">n</span> <span class="id" type="var">n0</span>); <span
class="id" type="tactic">try</span> <span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">ble\_nat</span> <span class="id" type="var">n</span> <span
class="id" type="var">n0</span>);\
          <span class="id" type="tactic">reflexivity</span>);\
     <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b</span>); <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">IHb</span>;
<span class="id" type="tactic">reflexivity</span>);\
     <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b1</span>);\
          <span class="id" type="tactic">destruct</span> (<span
class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b2</span>);\
          <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">IHb1</span>; <span class="id" type="tactic">rewrite</span>
<span class="id" type="var">IHb2</span>; <span class="id"
type="tactic">reflexivity</span>).\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Partial Evaluation of Commands, Without Loops {.section}
=============================================

<div class="paragraph">

</div>

What about the partial evaluation of commands? The analogy between
partial evaluation and full evaluation continues: Just as full
evaluation of a command turns an initial state into a final state,
partial evaluation of a command turns an initial partial state into a
final partial state. The difference is that, because the state is
partial, some parts of the command may not be executable at the static
stage. Therefore, just as <span class="inlinecode"><span class="id"
type="var">pe\_aexp</span></span> returns a residual <span
class="inlinecode"><span class="id" type="var">aexp</span></span> and
<span class="inlinecode"><span class="id"
type="var">pe\_bexp</span></span> returns a residual <span
class="inlinecode"><span class="id" type="var">bexp</span></span> above,
partially evaluating a command yields a residual command.
<div class="paragraph">

</div>

Another way in which our partial evaluator is similar to a full
evaluator is that it does not terminate on all commands. It is not hard
to build a partial evaluator that terminates on all commands; what is
hard is building a partial evaluator that terminates on all commands yet
automatically performs desired optimizations such as unrolling loops.
Often a partial evaluator can be coaxed into terminating more often and
performing more optimizations by writing the source program differently
so that the separation between static and dynamic information becomes
more apparent. Such coaxing is the art of *binding-time improvement*.
The binding time of a variable tells when its value is known — either
"static", or "dynamic."
<div class="paragraph">

</div>

Anyway, for now we will just live with the fact that our partial
evaluator is not a total function from the source command and the
initial partial state to the residual command and the final partial
state. To model this non-termination, just as with the full evaluation
of commands, we use an inductively defined relation. We write
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">c1</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">c1'</span> / <span class="id"
type="var">st'</span>
<div class="paragraph">

</div>

</div>

to mean that partially evaluating the source command <span
class="inlinecode"><span class="id" type="var">c1</span></span> in the
initial partial state <span class="inlinecode"><span class="id"
type="var">st</span></span> yields the residual command <span
class="inlinecode"><span class="id" type="var">c1'</span></span> and the
final partial state <span class="inlinecode"><span class="id"
type="var">st'</span></span>. For example, we want something like
<div class="paragraph">

</div>

<div class="code code-tight">

        (<span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3 ;; <span class="id"
type="var">Y</span> ::= <span class="id" type="var">AMult</span> (<span
class="id" type="var">AId</span> <span class="id"
type="var">Z</span>) (<span class="id" type="var">APlus</span> (<span
class="id" type="var">AId</span> <span class="id"
type="var">X</span>) (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>)))\
         / [] <span style="font-family: arial;">⇓</span> (<span
class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Z</span>) (<span class="id"
type="var">ANum</span> 6)) / [(<span class="id" type="var">X</span>,3)]
<div class="paragraph">

</div>

</div>

to hold. The assignment to <span class="inlinecode"><span class="id"
type="var">X</span></span> appears in the final partial state, not the
residual command.
<div class="paragraph">

</div>

Assignment {.section}
----------

<div class="paragraph">

</div>

Let's start by considering how to partially evaluate an assignment. The
two assignments in the source program above needs to be treated
differently. The first assignment <span class="inlinecode"><span
class="id" type="var">X</span></span> <span
class="inlinecode">::=</span> <span class="inlinecode"><span class="id"
type="var">ANum</span></span> <span class="inlinecode">3</span>, is
*static*: its right-hand-side is a constant (more generally, simplifies
to a constant), so we should update our partial state at <span
class="inlinecode"><span class="id" type="var">X</span></span> to <span
class="inlinecode">3</span> and produce no residual code. (Actually, we
produce a residual <span class="inlinecode"><span class="id"
type="var">SKIP</span></span>.) The second assignment <span
class="inlinecode"><span class="id" type="var">Y</span></span> <span
class="inlinecode">::=</span> <span class="inlinecode"><span class="id"
type="var">AMult</span></span> <span class="inlinecode">(<span
class="id" type="var">AId</span></span> <span class="inlinecode"><span
class="id" type="var">Z</span>)</span> <span class="inlinecode">(<span
class="id" type="var">APlus</span></span> <span
class="inlinecode">(<span class="id" type="var">AId</span></span> <span
class="inlinecode"><span class="id" type="var">X</span>)</span> <span
class="inlinecode">(<span class="id" type="var">AId</span></span> <span
class="inlinecode"><span class="id" type="var">X</span>))</span> is
*dynamic*: its right-hand-side does not simplify to a constant, so we
should leave it in the residual code and remove <span
class="inlinecode"><span class="id" type="var">Y</span></span>, if
present, from our partial state. To implement these two cases, we define
the functions <span class="inlinecode"><span class="id"
type="var">pe\_add</span></span> and <span class="inlinecode"><span
class="id" type="var">pe\_remove</span></span>. Like <span
class="inlinecode"><span class="id"
type="var">pe\_override</span></span> above, these functions operate on
a concrete <span class="inlinecode"><span class="id"
type="var">list</span></span> representing a <span
class="inlinecode"><span class="id" type="var">pe\_state</span></span>,
but the theorems <span class="inlinecode"><span class="id"
type="var">pe\_add\_correct</span></span> and <span
class="inlinecode"><span class="id"
type="var">pe\_remove\_correct</span></span> specify their behavior by
the <span class="inlinecode"><span class="id"
type="var">pe\_lookup</span></span> interpretation of the <span
class="inlinecode"><span class="id" type="var">pe\_state</span></span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_remove</span> (<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">V</span>:<span class="id"
type="var">id</span>) : <span class="id" type="var">pe\_state</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="keyword">with</span>\
   | [] ⇒ []\
   | (<span class="id" type="var">V'</span>,<span class="id"
type="var">n'</span>)::<span class="id" type="var">pe\_st</span> ⇒ <span
class="id" type="keyword">if</span> <span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V'</span> <span class="id"
type="keyword">then</span> <span class="id" type="var">pe\_remove</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">V</span>\
                       <span class="id" type="keyword">else</span>
(<span class="id" type="var">V'</span>,<span class="id"
type="var">n'</span>) :: <span class="id" type="var">pe\_remove</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">V</span>\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_remove\_correct</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span>,\
   <span class="id" type="var">pe\_lookup</span> (<span class="id"
type="var">pe\_remove</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span>) <span class="id"
type="var">V0</span>\
   = <span class="id" type="keyword">if</span> <span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span> <span class="id"
type="keyword">then</span> <span class="id" type="var">None</span> <span
class="id" type="keyword">else</span> <span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V0</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span> <span class="id"
type="var">V0</span>. <span class="id" type="tactic">induction</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="keyword">as</span> [| [<span class="id" type="var">V'</span> <span
class="id" type="var">n'</span>] <span class="id"
type="var">pe\_st</span>].\
   <span class="id" type="var">Case</span> "[]". <span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span>); <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "::". <span class="id"
type="tactic">simpl</span>. <span class="id" type="var">compare</span>
<span class="id" type="var">V</span> <span class="id"
type="var">V'</span> <span class="id" type="var">SCase</span>.\
     <span class="id" type="var">SCase</span> "equal". <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">IHpe\_st</span>.\
       <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span>). <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">neq\_id</span>;
<span class="id" type="tactic">auto</span>.\
     <span class="id" type="var">SCase</span> "not equal". <span
class="id" type="tactic">simpl</span>. <span class="id"
type="var">compare</span> <span class="id" type="var">V0</span> <span
class="id" type="var">V'</span> <span class="id"
type="var">SSCase</span>.\
       <span class="id" type="var">SSCase</span> "equal". <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">neq\_id</span>; <span class="id" type="tactic">auto</span>.\
       <span class="id" type="var">SSCase</span> "not equal". <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">IHpe\_st</span>. <span class="id"
type="tactic">reflexivity</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">pe\_add</span> (<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">V</span>:<span class="id"
type="var">id</span>) (<span class="id" type="var">n</span>:<span
class="id" type="var">nat</span>) : <span class="id"
type="var">pe\_state</span> :=\
   (<span class="id" type="var">V</span>,<span class="id"
type="var">n</span>) :: <span class="id" type="var">pe\_remove</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">V</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_add\_correct</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span> <span
class="id" type="var">n</span> <span class="id" type="var">V0</span>,\
   <span class="id" type="var">pe\_lookup</span> (<span class="id"
type="var">pe\_add</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span> <span class="id"
type="var">n</span>) <span class="id" type="var">V0</span>\
   = <span class="id" type="keyword">if</span> <span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span> <span class="id"
type="keyword">then</span> <span class="id" type="var">Some</span> <span
class="id" type="var">n</span> <span class="id"
type="keyword">else</span> <span class="id" type="var">pe\_lookup</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">V0</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span> <span class="id"
type="var">n</span> <span class="id" type="var">V0</span>. <span
class="id" type="tactic">unfold</span> <span class="id"
type="var">pe\_add</span>. <span class="id" type="tactic">simpl</span>.\
   <span class="id" type="var">compare</span> <span class="id"
type="var">V</span> <span class="id" type="var">V0</span> <span
class="id" type="var">Case</span>.\
   <span class="id" type="var">Case</span> "equal". <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">eq\_id</span>;
<span class="id" type="tactic">auto</span>.\
   <span class="id" type="var">Case</span> "not equal". <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_remove\_correct</span>. <span class="id"
type="tactic">repeat</span> <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">neq\_id</span>;
<span class="id" type="tactic">auto</span>.\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

We will use the two theorems below to show that our partial evaluator
correctly deals with dynamic assignments and static assignments,
respectively.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_override\_update\_remove</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">V</span> <span class="id" type="var">n</span>,\
   <span class="id" type="var">update</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="var">V</span> <span class="id" type="var">n</span> =\
   <span class="id" type="var">pe\_override</span> (<span class="id"
type="var">update</span> <span class="id" type="var">st</span> <span
class="id" type="var">V</span> <span class="id" type="var">n</span>)
(<span class="id" type="var">pe\_remove</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">V</span>
<span class="id" type="var">n</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">functional\_extensionality</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">V0</span>.\
   <span class="id" type="tactic">unfold</span> <span class="id"
type="var">update</span>. <span class="id" type="tactic">rewrite</span>
!<span class="id" type="var">pe\_override\_correct</span>. <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">pe\_remove\_correct</span>.\
   <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span>); <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_override\_update\_add</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">V</span> <span class="id" type="var">n</span>,\
   <span class="id" type="var">update</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="var">V</span> <span class="id" type="var">n</span> =\
   <span class="id" type="var">pe\_override</span> <span class="id"
type="var">st</span> (<span class="id" type="var">pe\_add</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">V</span>
<span class="id" type="var">n</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">V</span>
<span class="id" type="var">n</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">functional\_extensionality</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">V0</span>.\
   <span class="id" type="tactic">unfold</span> <span class="id"
type="var">update</span>. <span class="id" type="tactic">rewrite</span>
!<span class="id" type="var">pe\_override\_correct</span>. <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">pe\_add\_correct</span>.\
   <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span>); <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Conditional {.section}
-----------

<div class="paragraph">

</div>

Trickier than assignments to partially evaluate is the conditional,
<span class="inlinecode"><span class="id" type="var">IFB</span></span>
<span class="inlinecode"><span class="id" type="var">b1</span></span>
<span class="inlinecode"><span class="id" type="var">THEN</span></span>
<span class="inlinecode"><span class="id" type="var">c1</span></span>
<span class="inlinecode"><span class="id" type="var">ELSE</span></span>
<span class="inlinecode"><span class="id" type="var">c2</span></span>
<span class="inlinecode"><span class="id" type="var">FI</span></span>.
If <span class="inlinecode"><span class="id" type="var">b1</span></span>
simplifies to <span class="inlinecode"><span class="id"
type="var">BTrue</span></span> or <span class="inlinecode"><span
class="id" type="var">BFalse</span></span> then it's easy: we know which
branch will be taken, so just take that branch. If <span
class="inlinecode"><span class="id" type="var">b1</span></span> does not
simplify to a constant, then we need to take both branches, and the
final partial state may differ between the two branches!
<div class="paragraph">

</div>

The following program illustrates the difficulty:
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;;\
         <span class="id" type="var">IFB</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">ANum</span> 4) <span class="id" type="var">THEN</span>\
             <span class="id" type="var">Y</span> ::= <span class="id"
type="var">ANum</span> 4;;\
             <span class="id" type="var">IFB</span> <span class="id"
type="var">BEq</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>) <span
class="id" type="var">THEN</span> <span class="id"
type="var">Y</span> ::= <span class="id"
type="var">ANum</span> 999 <span class="id" type="var">ELSE</span> <span
class="id" type="var">SKIP</span> <span class="id" type="var">FI</span>\
         <span class="id" type="var">ELSE</span> <span class="id"
type="var">SKIP</span> <span class="id" type="var">FI</span>
<div class="paragraph">

</div>

</div>

Suppose the initial partial state is empty. We don't know statically how
<span class="inlinecode"><span class="id" type="var">Y</span></span>
compares to <span class="inlinecode">4</span>, so we must partially
evaluate both branches of the (outer) conditional. On the <span
class="inlinecode"><span class="id" type="var">THEN</span></span>
branch, we know that <span class="inlinecode"><span class="id"
type="var">Y</span></span> is set to <span class="inlinecode">4</span>
and can even use that knowledge to simplify the code somewhat. On the
<span class="inlinecode"><span class="id" type="var">ELSE</span></span>
branch, we still don't know the exact value of <span
class="inlinecode"><span class="id" type="var">Y</span></span> at the
end. What should the final partial state and residual program be?
<div class="paragraph">

</div>

One way to handle such a dynamic conditional is to take the intersection
of the final partial states of the two branches. In this example, we
take the intersection of <span class="inlinecode">(<span class="id"
type="var">Y</span>,4),(<span class="id" type="var">X</span>,3)</span>
and <span class="inlinecode">(<span class="id"
type="var">X</span>,3)</span>, so the overall final partial state is
<span class="inlinecode">(<span class="id"
type="var">X</span>,3)</span>. To compensate for forgetting that <span
class="inlinecode"><span class="id" type="var">Y</span></span> is <span
class="inlinecode">4</span>, we need to add an assignment <span
class="inlinecode"><span class="id" type="var">Y</span></span> <span
class="inlinecode">::=</span> <span class="inlinecode"><span class="id"
type="var">ANum</span></span> <span class="inlinecode">4</span> to the
end of the <span class="inlinecode"><span class="id"
type="var">THEN</span></span> branch. So, the residual program will be
something like
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">SKIP</span>;;\
         <span class="id" type="var">IFB</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">ANum</span> 4) <span class="id" type="var">THEN</span>\
             <span class="id" type="var">SKIP</span>;;\
             <span class="id" type="var">SKIP</span>;;\
             <span class="id" type="var">Y</span> ::= <span class="id"
type="var">ANum</span> 4\
         <span class="id" type="var">ELSE</span> <span class="id"
type="var">SKIP</span> <span class="id" type="var">FI</span>
<div class="paragraph">

</div>

</div>

<div class="paragraph">

</div>

Programming this case in Coq calls for several auxiliary functions: we
need to compute the intersection of two <span class="inlinecode"><span
class="id" type="var">pe\_state</span></span>s and turn their difference
into sequences of assignments.
<div class="paragraph">

</div>

First, we show how to compute whether two <span class="inlinecode"><span
class="id" type="var">pe\_state</span></span>s to disagree at a given
variable. In the theorem <span class="inlinecode"><span class="id"
type="var">pe\_disagree\_domain</span></span>, we prove that two <span
class="inlinecode"><span class="id" type="var">pe\_state</span></span>s
can only disagree at variables that appear in at least one of them.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">pe\_disagree\_at</span> (<span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span> :
<span class="id" type="var">pe\_state</span>) (<span class="id"
type="var">V</span>:<span class="id" type="var">id</span>) : <span
class="id" type="var">bool</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">V</span>, <span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span> <span class="id"
type="keyword">with</span>\
   | <span class="id" type="var">Some</span> <span class="id"
type="var">x</span>, <span class="id" type="var">Some</span> <span
class="id" type="var">y</span> ⇒ <span class="id" type="var">negb</span>
(<span class="id" type="var">beq\_nat</span> <span class="id"
type="var">x</span> <span class="id" type="var">y</span>)\
   | <span class="id" type="var">None</span>, <span class="id"
type="var">None</span> ⇒ <span class="id" type="var">false</span>\
   | <span class="id" type="var">\_</span>, <span class="id"
type="var">\_</span> ⇒ <span class="id" type="var">true</span>\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_disagree\_domain</span>: <span
style="font-family: arial;">∀</span>(<span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span> :
<span class="id" type="var">pe\_state</span>) (<span class="id"
type="var">V</span>:<span class="id" type="var">id</span>),\
   <span class="id" type="var">true</span> = <span class="id"
type="var">pe\_disagree\_at</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span> <span
style="font-family: arial;">→</span>\
   <span class="id" type="var">In</span> <span class="id"
type="var">V</span> (<span class="id" type="var">map</span> (@<span
class="id" type="var">fst</span> <span class="id" type="var">\_</span>
<span class="id" type="var">\_</span>) <span class="id"
type="var">pe\_st1</span> ++ <span class="id" type="var">map</span>
(@<span class="id" type="var">fst</span> <span class="id"
type="var">\_</span> <span class="id" type="var">\_</span>) <span
class="id" type="var">pe\_st2</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">unfold</span> <span class="id"
type="var">pe\_disagree\_at</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">V</span> <span class="id" type="var">H</span>.\
   <span class="id" type="tactic">apply</span> <span class="id"
type="var">in\_or\_app</span>.\
   <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">V</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">lookup1</span>.\
   <span class="id" type="tactic">destruct</span> <span class="id"
type="var">lookup1</span> <span class="id" type="keyword">as</span>
[<span class="id" type="var">n1</span>|]. <span class="id"
type="var">left</span>. <span class="id" type="tactic">apply</span>
<span class="id" type="var">pe\_domain</span> <span class="id"
type="keyword">with</span> <span class="id" type="var">n1</span>. <span
class="id" type="tactic">auto</span>.\
   <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">lookup2</span>.\
   <span class="id" type="tactic">destruct</span> <span class="id"
type="var">lookup2</span> <span class="id" type="keyword">as</span>
[<span class="id" type="var">n2</span>|]. <span class="id"
type="var">right</span>. <span class="id" type="tactic">apply</span>
<span class="id" type="var">pe\_domain</span> <span class="id"
type="keyword">with</span> <span class="id" type="var">n2</span>. <span
class="id" type="tactic">auto</span>.\
   <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H</span>. <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

We define the <span class="inlinecode"><span class="id"
type="var">pe\_compare</span></span> function to list the variables
where two given <span class="inlinecode"><span class="id"
type="var">pe\_state</span></span>s disagree. This list is exact,
according to the theorem <span class="inlinecode"><span class="id"
type="var">pe\_compare\_correct</span></span>: a variable appears on the
list if and only if the two given <span class="inlinecode"><span
class="id" type="var">pe\_state</span></span>s disagree at that
variable. Furthermore, we use the <span class="inlinecode"><span
class="id" type="var">pe\_unique</span></span> function to eliminate
duplicates from the list.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_unique</span> (<span class="id" type="var">l</span> :
<span class="id" type="var">list</span> <span class="id"
type="var">id</span>) : <span class="id" type="var">list</span> <span
class="id" type="var">id</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">l</span> <span class="id" type="keyword">with</span>\
   | [] ⇒ []\
   | <span class="id" type="var">x</span>::<span class="id"
type="var">l</span> ⇒ <span class="id" type="var">x</span> :: <span
class="id" type="var">filter</span> (<span class="id"
type="keyword">fun</span> <span class="id" type="var">y</span> ⇒ <span
class="id" type="keyword">if</span> <span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">x</span> <span
class="id" type="var">y</span> <span class="id"
type="keyword">then</span> <span class="id" type="var">false</span>
<span class="id" type="keyword">else</span> <span class="id"
type="var">true</span>) (<span class="id" type="var">pe\_unique</span>
<span class="id" type="var">l</span>)\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_unique\_correct</span>: <span
style="font-family: arial;">∀</span><span class="id" type="var">l</span>
<span class="id" type="var">x</span>,\
   <span class="id" type="var">In</span> <span class="id"
type="var">x</span> <span class="id" type="var">l</span> <span
style="font-family: arial;">↔</span> <span class="id"
type="var">In</span> <span class="id" type="var">x</span> (<span
class="id" type="var">pe\_unique</span> <span class="id"
type="var">l</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">l</span> <span
class="id" type="var">x</span>. <span class="id"
type="tactic">induction</span> <span class="id" type="var">l</span>
<span class="id" type="keyword">as</span> [| <span class="id"
type="var">h</span> <span class="id" type="var">t</span>]. <span
class="id" type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">simpl</span> <span class="id"
type="keyword">in</span> ×. <span class="id"
type="tactic">split</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">→</span>".\
     <span class="id" type="tactic">intros</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>;
<span class="id" type="tactic">clear</span> <span class="id"
type="var">H</span>.\
       <span class="id" type="var">left</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">h</span> <span
class="id" type="var">x</span>).\
          <span class="id" type="var">left</span>. <span class="id"
type="tactic">assumption</span>.\
          <span class="id" type="var">right</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">filter\_In</span>. <span class="id"
type="tactic">split</span>.\
            <span class="id" type="tactic">apply</span> <span class="id"
type="var">IHt</span>. <span class="id"
type="tactic">assumption</span>.\
            <span class="id" type="tactic">rewrite</span> <span
class="id" type="var">neq\_id</span>; <span class="id"
type="tactic">auto</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">←</span>".\
     <span class="id" type="tactic">intros</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>;
<span class="id" type="tactic">clear</span> <span class="id"
type="var">H</span>.\
        <span class="id" type="var">left</span>. <span class="id"
type="tactic">assumption</span>.\
        <span class="id" type="tactic">apply</span> <span class="id"
type="var">filter\_In</span> <span class="id" type="keyword">in</span>
<span class="id" type="var">H0</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H0</span>.
<span class="id" type="var">right</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">IHt</span>. <span
class="id" type="tactic">assumption</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">pe\_compare</span> (<span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span> :
<span class="id" type="var">pe\_state</span>) : <span class="id"
type="var">list</span> <span class="id" type="var">id</span> :=\
   <span class="id" type="var">pe\_unique</span> (<span class="id"
type="var">filter</span> (<span class="id"
type="var">pe\_disagree\_at</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>)\
     (<span class="id" type="var">map</span> (@<span class="id"
type="var">fst</span> <span class="id" type="var">\_</span> <span
class="id" type="var">\_</span>) <span class="id"
type="var">pe\_st1</span> ++ <span class="id" type="var">map</span>
(@<span class="id" type="var">fst</span> <span class="id"
type="var">\_</span> <span class="id" type="var">\_</span>) <span
class="id" type="var">pe\_st2</span>)).\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_compare\_correct</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span>,\
   <span class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">V</span> = <span
class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st2</span> <span class="id" type="var">V</span> <span
style="font-family: arial;">↔</span>\
   ¬ <span class="id" type="var">In</span> <span class="id"
type="var">V</span> (<span class="id" type="var">pe\_compare</span>
<span class="id" type="var">pe\_st1</span> <span class="id"
type="var">pe\_st2</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">V</span>.\
   <span class="id" type="tactic">unfold</span> <span class="id"
type="var">pe\_compare</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">←</span>
<span class="id" type="var">pe\_unique\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">filter\_In</span>.\
   <span class="id" type="tactic">split</span>; <span class="id"
type="tactic">intros</span> <span class="id" type="var">Heq</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">→</span>".\
     <span class="id" type="tactic">intro</span>. <span class="id"
type="tactic">destruct</span> <span class="id" type="var">H</span>.
<span class="id" type="tactic">unfold</span> <span class="id"
type="var">pe\_disagree\_at</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H0</span>. <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">Heq</span> <span class="id" type="keyword">in</span> <span
class="id" type="var">H0</span>.\
     <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span>).\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">beq\_nat\_refl</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H0</span>. <span
class="id" type="tactic">inversion</span> <span class="id"
type="var">H0</span>.\
     <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H0</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">←</span>".\
     <span class="id" type="tactic">assert</span> (<span class="id"
type="var">Hagree</span>: <span class="id"
type="var">pe\_disagree\_at</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span> = <span class="id"
type="var">false</span>).\
       <span class="id" type="var">SCase</span> "Proof of assertion".\
       <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_disagree\_at</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">disagree</span>.\
       <span class="id" type="tactic">destruct</span> <span class="id"
type="var">disagree</span>; [| <span class="id"
type="tactic">reflexivity</span>].\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">pe\_disagree\_domain</span> <span class="id"
type="keyword">in</span> <span class="id"
type="var">Heqdisagree</span>.\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">ex\_falso\_quodlibet</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">Heq</span>. <span
class="id" type="tactic">split</span>. <span class="id"
type="tactic">assumption</span>. <span class="id"
type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">unfold</span> <span class="id"
type="var">pe\_disagree\_at</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Hagree</span>.\
     <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">V</span>) <span class="id"
type="keyword">as</span> [<span class="id" type="var">n1</span>|];\
     <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span>) <span class="id"
type="keyword">as</span> [<span class="id" type="var">n2</span>|];\
       <span class="id" type="tactic">try</span> <span class="id"
type="tactic">reflexivity</span>; <span class="id"
type="tactic">try</span> <span class="id" type="var">solve</span> <span
class="id" type="tactic">by</span> <span class="id"
type="tactic">inversion</span>.\
     <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">negb\_false\_iff</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Hagree</span>.\
     <span class="id" type="tactic">apply</span> <span class="id"
type="var">beq\_nat\_true</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Hagree</span>.
<span class="id" type="tactic">subst</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

The intersection of two partial states is the result of removing from
one of them all the variables where the two disagree. We define the
function <span class="inlinecode"><span class="id"
type="var">pe\_removes</span></span>, in terms of <span
class="inlinecode"><span class="id" type="var">pe\_remove</span></span>
above, to perform such a removal of a whole list of variables at once.
<div class="paragraph">

</div>

The theorem <span class="inlinecode"><span class="id"
type="var">pe\_compare\_removes</span></span> testifies that the <span
class="inlinecode"><span class="id" type="var">pe\_lookup</span></span>
interpretation of the result of this intersection operation is the same
no matter which of the two partial states we remove the variables from.
Because <span class="inlinecode"><span class="id"
type="var">pe\_override</span></span> only depends on the <span
class="inlinecode"><span class="id" type="var">pe\_lookup</span></span>
interpretation of partial states, <span class="inlinecode"><span
class="id" type="var">pe\_override</span></span> also does not care
which of the two partial states we remove the variables from; that
theorem <span class="inlinecode"><span class="id"
type="var">pe\_compare\_override</span></span> is used in the
correctness proof shortly.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_removes</span> (<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">ids</span> : <span class="id"
type="var">list</span> <span class="id" type="var">id</span>) : <span
class="id" type="var">pe\_state</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">ids</span> <span class="id" type="keyword">with</span>\
   | [] ⇒ <span class="id" type="var">pe\_st</span>\
   | <span class="id" type="var">V</span>::<span class="id"
type="var">ids</span> ⇒ <span class="id" type="var">pe\_remove</span>
(<span class="id" type="var">pe\_removes</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">ids</span>) <span
class="id" type="var">V</span>\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_removes\_correct</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">ids</span> <span
class="id" type="var">V</span>,\
   <span class="id" type="var">pe\_lookup</span> (<span class="id"
type="var">pe\_removes</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">ids</span>) <span class="id"
type="var">V</span> =\
   <span class="id" type="keyword">if</span> <span class="id"
type="var">in\_dec</span> <span class="id" type="var">eq\_id\_dec</span>
<span class="id" type="var">V</span> <span class="id"
type="var">ids</span> <span class="id" type="keyword">then</span> <span
class="id" type="var">None</span> <span class="id"
type="keyword">else</span> <span class="id" type="var">pe\_lookup</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">V</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">ids</span> <span class="id"
type="var">V</span>. <span class="id" type="tactic">induction</span>
<span class="id" type="var">ids</span> <span class="id"
type="keyword">as</span> [| <span class="id" type="var">V'</span> <span
class="id" type="var">ids</span>]. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">simpl</span>. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_remove\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">IHids</span>.\
   <span class="id" type="var">compare</span> <span class="id"
type="var">V'</span> <span class="id" type="var">V</span> <span
class="id" type="var">Case</span>.\
     <span class="id" type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">in\_dec</span> <span class="id" type="var">eq\_id\_dec</span>
<span class="id" type="var">V</span> <span class="id"
type="var">ids</span>);\
       <span class="id" type="tactic">reflexivity</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_compare\_removes</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span>,\
   <span class="id" type="var">pe\_lookup</span> (<span class="id"
type="var">pe\_removes</span> <span class="id" type="var">pe\_st1</span>
(<span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>))
<span class="id" type="var">V</span> =\
   <span class="id" type="var">pe\_lookup</span> (<span class="id"
type="var">pe\_removes</span> <span class="id" type="var">pe\_st2</span>
(<span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>))
<span class="id" type="var">V</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">V</span>. <span class="id" type="tactic">rewrite</span>
!<span class="id" type="var">pe\_removes\_correct</span>.\
   <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">in\_dec</span> <span class="id" type="var">eq\_id\_dec</span>
<span class="id" type="var">V</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>)).\
     <span class="id" type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">apply</span> <span class="id"
type="var">pe\_compare\_correct</span>. <span class="id"
type="tactic">auto</span>. <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_compare\_override</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">st</span>,\
   <span class="id" type="var">pe\_override</span> <span class="id"
type="var">st</span> (<span class="id" type="var">pe\_removes</span>
<span class="id" type="var">pe\_st1</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>)) =\
   <span class="id" type="var">pe\_override</span> <span class="id"
type="var">st</span> (<span class="id" type="var">pe\_removes</span>
<span class="id" type="var">pe\_st2</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>)).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span>. <span class="id" type="tactic">apply</span>
<span class="id" type="var">functional\_extensionality</span>. <span
class="id" type="tactic">intros</span> <span class="id"
type="var">V</span>.\
   <span class="id" type="tactic">rewrite</span> !<span class="id"
type="var">pe\_override\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_compare\_removes</span>. <span class="id"
type="tactic">reflexivity</span>.\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Finally, we define an <span class="inlinecode"><span class="id"
type="var">assign</span></span> function to turn the difference between
two partial states into a sequence of assignment commands. More
precisely, <span class="inlinecode"><span class="id"
type="var">assign</span></span> <span class="inlinecode"><span
class="id" type="var">pe\_st</span></span> <span
class="inlinecode"><span class="id" type="var">ids</span></span>
generates an assignment command for each variable listed in <span
class="inlinecode"><span class="id" type="var">ids</span></span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">assign</span> (<span class="id" type="var">pe\_st</span> :
<span class="id" type="var">pe\_state</span>) (<span class="id"
type="var">ids</span> : <span class="id" type="var">list</span> <span
class="id" type="var">id</span>) : <span class="id"
type="var">com</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">ids</span> <span class="id" type="keyword">with</span>\
   | [] ⇒ <span class="id" type="var">SKIP</span>\
   | <span class="id" type="var">V</span>::<span class="id"
type="var">ids</span> ⇒ <span class="id" type="keyword">match</span>
<span class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span> <span
class="id" type="keyword">with</span>\
               | <span class="id" type="var">Some</span> <span
class="id" type="var">n</span> ⇒ (<span class="id"
type="var">assign</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">ids</span>;; <span class="id" type="var">V</span>
::= <span class="id" type="var">ANum</span> <span class="id"
type="var">n</span>)\
               | <span class="id" type="var">None</span> ⇒ <span
class="id" type="var">assign</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">ids</span>\
               <span class="id" type="keyword">end</span>\
   <span class="id" type="keyword">end</span>.\
\

</div>

<div class="doc">

The command generated by <span class="inlinecode"><span class="id"
type="var">assign</span></span> always terminates, because it is just a
sequence of assignments. The (total) function <span
class="inlinecode"><span class="id" type="var">assigned</span></span>
below computes the effect of the command on the (dynamic state). The
theorem <span class="inlinecode"><span class="id"
type="var">assign\_removes</span></span> then confirms that the
generated assignments perfectly compensate for removing the variables
from the partial state.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">assigned</span> (<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">ids</span> : <span class="id"
type="var">list</span> <span class="id" type="var">id</span>) (<span
class="id" type="var">st</span>:<span class="id"
type="var">state</span>) : <span class="id" type="var">state</span> :=\
   <span class="id" type="keyword">fun</span> <span class="id"
type="var">V</span> ⇒ <span class="id" type="keyword">if</span> <span
class="id" type="var">in\_dec</span> <span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">ids</span> <span class="id"
type="keyword">then</span>\
                 <span class="id" type="keyword">match</span> <span
class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span> <span
class="id" type="keyword">with</span>\
                 | <span class="id" type="var">Some</span> <span
class="id" type="var">n</span> ⇒ <span class="id" type="var">n</span>\
                 | <span class="id" type="var">None</span> ⇒ <span
class="id" type="var">st</span> <span class="id" type="var">V</span>\
                 <span class="id" type="keyword">end</span>\
            <span class="id" type="keyword">else</span> <span class="id"
type="var">st</span> <span class="id" type="var">V</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">assign\_removes</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">ids</span> <span
class="id" type="var">st</span>,\
   <span class="id" type="var">pe\_override</span> <span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> =\
   <span class="id" type="var">pe\_override</span> (<span class="id"
type="var">assigned</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">ids</span> <span class="id"
type="var">st</span>) (<span class="id" type="var">pe\_removes</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">ids</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">ids</span> <span class="id"
type="var">st</span>. <span class="id" type="tactic">apply</span> <span
class="id" type="var">functional\_extensionality</span>. <span
class="id" type="tactic">intros</span> <span class="id"
type="var">V</span>.\
   <span class="id" type="tactic">rewrite</span> !<span class="id"
type="var">pe\_override\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_removes\_correct</span>. <span class="id"
type="tactic">unfold</span> <span class="id"
type="var">assigned</span>.\
   <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">in\_dec</span> <span class="id" type="var">eq\_id\_dec</span>
<span class="id" type="var">V</span> <span class="id"
type="var">ids</span>); <span class="id" type="tactic">destruct</span>
(<span class="id" type="var">pe\_lookup</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">V</span>); <span
class="id" type="tactic">reflexivity</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Lemma</span> <span class="id"
type="var">ceval\_extensionality</span>: <span
style="font-family: arial;">∀</span><span class="id" type="var">c</span>
<span class="id" type="var">st</span> <span class="id"
type="var">st1</span> <span class="id" type="var">st2</span>,\
   <span class="id" type="var">c</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st1</span> <span
style="font-family: arial;">→</span> (<span
style="font-family: arial;">∀</span><span class="id"
type="var">V</span>, <span class="id" type="var">st1</span> <span
class="id" type="var">V</span> = <span class="id" type="var">st2</span>
<span class="id" type="var">V</span>) <span
style="font-family: arial;">→</span> <span class="id"
type="var">c</span> / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st2</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">st</span> <span class="id" type="var">st1</span>
<span class="id" type="var">st2</span> <span class="id"
type="var">H</span> <span class="id" type="var">Heq</span>.\
   <span class="id" type="tactic">apply</span> <span class="id"
type="var">functional\_extensionality</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heq</span>. <span
class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">Heq</span>. <span class="id" type="tactic">apply</span> <span
class="id" type="var">H</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">eval\_assign</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">ids</span> <span
class="id" type="var">st</span>,\
   <span class="id" type="var">assign</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">ids</span> / <span
class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">assigned</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">ids</span> <span class="id"
type="var">st</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">ids</span> <span class="id"
type="var">st</span>. <span class="id" type="tactic">induction</span>
<span class="id" type="var">ids</span> <span class="id"
type="keyword">as</span> [| <span class="id" type="var">V</span> <span
class="id" type="var">ids</span>]; <span class="id"
type="tactic">simpl</span>.\
   <span class="id" type="var">Case</span> "[]". <span class="id"
type="tactic">eapply</span> <span class="id"
type="var">ceval\_extensionality</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_Skip</span>.
<span class="id" type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "V::ids".\
     <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_lookup</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">V</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">lookup</span>.
<span class="id" type="tactic">destruct</span> <span class="id"
type="var">lookup</span>.\
     <span class="id" type="var">SCase</span> "Some". <span class="id"
type="tactic">eapply</span> <span class="id" type="var">E\_Seq</span>.
<span class="id" type="tactic">apply</span> <span class="id"
type="var">IHids</span>. <span class="id" type="tactic">unfold</span>
<span class="id" type="var">assigned</span>. <span class="id"
type="tactic">simpl</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">ceval\_extensionality</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_Ass</span>.
<span class="id" type="tactic">simpl</span>. <span class="id"
type="tactic">reflexivity</span>.\
       <span class="id" type="tactic">intros</span> <span class="id"
type="var">V0</span>. <span class="id" type="tactic">unfold</span> <span
class="id" type="var">update</span>. <span class="id"
type="var">compare</span> <span class="id" type="var">V</span> <span
class="id" type="var">V0</span> <span class="id"
type="var">SSCase</span>.\
       <span class="id" type="var">SSCase</span> "equal". <span
class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">Heqlookup</span>. <span class="id"
type="tactic">reflexivity</span>.\
       <span class="id" type="var">SSCase</span> "not equal". <span
class="id" type="tactic">destruct</span> (<span class="id"
type="var">in\_dec</span> <span class="id" type="var">eq\_id\_dec</span>
<span class="id" type="var">V0</span> <span class="id"
type="var">ids</span>); <span class="id" type="tactic">auto</span>.\
     <span class="id" type="var">SCase</span> "None". <span class="id"
type="tactic">eapply</span> <span class="id"
type="var">ceval\_extensionality</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">IHids</span>.\
       <span class="id" type="tactic">unfold</span> <span class="id"
type="var">assigned</span>. <span class="id" type="tactic">intros</span>
<span class="id" type="var">V0</span>. <span class="id"
type="tactic">simpl</span>. <span class="id" type="var">compare</span>
<span class="id" type="var">V</span> <span class="id"
type="var">V0</span> <span class="id" type="var">SSCase</span>.\
       <span class="id" type="var">SSCase</span> "equal". <span
class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">Heqlookup</span>.\
         <span class="id" type="tactic">destruct</span> (<span
class="id" type="var">in\_dec</span> <span class="id"
type="var">eq\_id\_dec</span> <span class="id" type="var">V</span> <span
class="id" type="var">ids</span>); <span class="id"
type="tactic">reflexivity</span>.\
       <span class="id" type="var">SSCase</span> "not equal". <span
class="id" type="tactic">destruct</span> (<span class="id"
type="var">in\_dec</span> <span class="id" type="var">eq\_id\_dec</span>
<span class="id" type="var">V0</span> <span class="id"
type="var">ids</span>); <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

The Partial Evaluation Relation {.section}
-------------------------------

<div class="paragraph">

</div>

At long last, we can define a partial evaluator for commands without
loops, as an inductive relation! The inequality conditions in <span
class="inlinecode"><span class="id"
type="var">PE\_AssDynamic</span></span> and <span
class="inlinecode"><span class="id" type="var">PE\_If</span></span> are
just to keep the partial evaluator deterministic; they are not required
for correctness.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Reserved Notation</span> "c1 '/' st
'<span style="font-family: arial;">⇓</span>' c1' '/' st'"\
   (<span class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 40, <span class="id" type="var">st</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39, <span class="id" type="var">c1'</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39).\
\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">pe\_com</span> : <span class="id" type="var">com</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_state</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">com</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_state</span> <span style="font-family: arial;">→</span>
<span class="id" type="keyword">Prop</span> :=\
   | <span class="id" type="var">PE\_Skip</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span>,\
       <span class="id" type="var">SKIP</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">SKIP</span> / <span class="id"
type="var">pe\_st</span>\
   | <span class="id" type="var">PE\_AssStatic</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> <span
class="id" type="var">n1</span> <span class="id" type="var">l</span>,\
       <span class="id" type="var">pe\_aexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> = <span
class="id" type="var">ANum</span> <span class="id" type="var">n1</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">l</span> ::= <span class="id"
type="var">a1</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">SKIP</span> / <span class="id" type="var">pe\_add</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">l</span> <span class="id" type="var">n1</span>\
   | <span class="id" type="var">PE\_AssDynamic</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> <span
class="id" type="var">a1'</span> <span class="id" type="var">l</span>,\
       <span class="id" type="var">pe\_aexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> = <span
class="id" type="var">a1'</span> <span
style="font-family: arial;">→</span>\
       (<span style="font-family: arial;">∀</span><span class="id"
type="var">n</span>, <span class="id" type="var">a1'</span> ≠ <span
class="id" type="var">ANum</span> <span class="id" type="var">n</span>)
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">l</span> ::= <span class="id"
type="var">a1</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> (<span class="id"
type="var">l</span> ::= <span class="id" type="var">a1'</span>) / <span
class="id" type="var">pe\_remove</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">l</span>\
   | <span class="id" type="var">PE\_Seq</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">pe\_st''</span> <span class="id"
type="var">c1</span> <span class="id" type="var">c2</span> <span
class="id" type="var">c1'</span> <span class="id"
type="var">c2'</span>,\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> <span style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">pe\_st'</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c2'</span> / <span class="id"
type="var">pe\_st''</span> <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">c1</span> ;; <span class="id"
type="var">c2</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> (<span class="id"
type="var">c1'</span> ;; <span class="id" type="var">c2'</span>) / <span
class="id" type="var">pe\_st''</span>\
   | <span class="id" type="var">PE\_IfTrue</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">b1</span> <span class="id"
type="var">c1</span> <span class="id" type="var">c2</span> <span
class="id" type="var">c1'</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c1'</span> / <span class="id" type="var">pe\_st'</span>\
   | <span class="id" type="var">PE\_IfFalse</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">b1</span> <span class="id"
type="var">c1</span> <span class="id" type="var">c2</span> <span
class="id" type="var">c2'</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c2'</span> / <span class="id"
type="var">pe\_st'</span> <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c2'</span> / <span class="id" type="var">pe\_st'</span>\
   | <span class="id" type="var">PE\_If</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">b1</span> <span class="id" type="var">c1</span> <span
class="id" type="var">c2</span> <span class="id" type="var">c1'</span>
<span class="id" type="var">c2'</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st1</span> <span style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c2'</span> / <span class="id"
type="var">pe\_st2</span> <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">pe\_st</span>\
         <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">IFB</span> <span class="id" type="var">pe\_bexp</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">b1</span>\
              <span class="id" type="var">THEN</span> <span class="id"
type="var">c1'</span> ;; <span class="id" type="var">assign</span> <span
class="id" type="var">pe\_st1</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>)\
              <span class="id" type="var">ELSE</span> <span class="id"
type="var">c2'</span> ;; <span class="id" type="var">assign</span> <span
class="id" type="var">pe\_st2</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>) <span class="id"
type="var">FI</span>)\
             / <span class="id" type="var">pe\_removes</span> <span
class="id" type="var">pe\_st1</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>)\
\
   <span class="id" type="keyword">where</span> "c1 '/' st '<span
style="font-family: arial;">⇓</span>' c1' '/' st'" := (<span class="id"
type="var">pe\_com</span> <span class="id" type="var">c1</span> <span
class="id" type="var">st</span> <span class="id" type="var">c1'</span>
<span class="id" type="var">st'</span>).\
\
 <span class="id" type="keyword">Tactic Notation</span> "pe\_com\_cases"
<span class="id" type="var">tactic</span>(<span class="id"
type="var">first</span>) <span class="id" type="var">ident</span>(<span
class="id" type="var">c</span>) :=\
   <span class="id" type="var">first</span>;\
   [ <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_Skip"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_AssStatic" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"PE\_AssDynamic"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_Seq"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_IfTrue" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"PE\_IfFalse" | <span class="id" type="var">Case\_aux</span> <span
class="id" type="var">c</span> "PE\_If" ].\
\
 <span class="id" type="keyword">Hint</span> <span class="id"
type="var">Constructors</span> <span class="id"
type="var">pe\_com</span>.\
 <span class="id" type="keyword">Hint</span> <span class="id"
type="var">Constructors</span> <span class="id"
type="var">ceval</span>.\
\

</div>

<div class="doc">

Examples {.section}
--------

<div class="paragraph">

</div>

Below are some examples of using the partial evaluator. To make the
<span class="inlinecode"><span class="id"
type="var">pe\_com</span></span> relation actually usable for automatic
partial evaluation, we would need to define more automation tactics in
Coq. That is not hard to do, but it is not needed here.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_example1</span>:\
   (<span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3 ;; <span class="id" type="var">Y</span> ::=
<span class="id" type="var">AMult</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">Z</span>) (<span
class="id" type="var">APlus</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">X</span>) (<span
class="id" type="var">AId</span> <span class="id"
type="var">X</span>)))\
   / [] <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">SKIP</span>;; <span class="id" type="var">Y</span> ::= <span
class="id" type="var">AMult</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">Z</span>) (<span
class="id" type="var">ANum</span> 6)) / [(<span class="id"
type="var">X</span>,3)].\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">eapply</span> <span class="id" type="var">PE\_Seq</span>.
<span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_AssDynamic</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">n</span> <span
class="id" type="var">H</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>.
<span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_example2</span>:\
   (<span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3 ;; <span class="id" type="var">IFB</span> <span
class="id" type="var">BLe</span> (<span class="id" type="var">AId</span>
<span class="id" type="var">X</span>) (<span class="id"
type="var">ANum</span> 4) <span class="id" type="var">THEN</span> <span
class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 4 <span class="id" type="var">ELSE</span> <span
class="id" type="var">SKIP</span> <span class="id"
type="var">FI</span>)\
   / [] <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">SKIP</span>;; <span class="id" type="var">SKIP</span>) /
[(<span class="id" type="var">X</span>,4)].\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">eapply</span> <span class="id" type="var">PE\_Seq</span>.
<span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_IfTrue</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_example3</span>:\
   (<span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;;\
    <span class="id" type="var">IFB</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span>
4) <span class="id" type="var">THEN</span>\
      <span class="id" type="var">Y</span> ::= <span class="id"
type="var">ANum</span> 4;;\
      <span class="id" type="var">IFB</span> <span class="id"
type="var">BEq</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id" type="var">AId</span>
<span class="id" type="var">Y</span>) <span class="id"
type="var">THEN</span> <span class="id" type="var">Y</span> ::= <span
class="id" type="var">ANum</span> 999 <span class="id"
type="var">ELSE</span> <span class="id" type="var">SKIP</span> <span
class="id" type="var">FI</span>\
    <span class="id" type="var">ELSE</span> <span class="id"
type="var">SKIP</span> <span class="id" type="var">FI</span>) / []\
   <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">SKIP</span>;;\
        <span class="id" type="var">IFB</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id" type="var">ANum</span>
4) <span class="id" type="var">THEN</span>\
          (<span class="id" type="var">SKIP</span>;; <span class="id"
type="var">SKIP</span>);; (<span class="id" type="var">SKIP</span>;;
<span class="id" type="var">Y</span> ::= <span class="id"
type="var">ANum</span> 4)\
        <span class="id" type="var">ELSE</span> <span class="id"
type="var">SKIP</span>;; <span class="id" type="var">SKIP</span> <span
class="id" type="var">FI</span>)\
       / [(<span class="id" type="var">X</span>,3)].\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="var">erewrite</span> <span class="id" type="var">f\_equal2</span>
<span class="id" type="keyword">with</span> (<span class="id"
type="var">f</span> := <span class="id" type="keyword">fun</span> <span
class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒
<span class="id" type="var">\_</span> / <span class="id"
type="var">\_</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">c</span> / <span class="id"
type="var">st</span>).\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_Seq</span>. <span class="id" type="tactic">eapply</span>
<span class="id" type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_If</span>; <span class="id"
type="tactic">intuition</span> <span class="id"
type="tactic">eauto</span>; <span class="id" type="tactic">try</span>
<span class="id" type="var">solve</span> <span class="id"
type="tactic">by</span> <span class="id"
type="tactic">inversion</span>.\
   <span class="id" type="var">econstructor</span>. <span class="id"
type="tactic">eapply</span> <span class="id"
type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_IfFalse</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="var">econstructor</span>.\
   <span class="id" type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Correctness of Partial Evaluation {.section}
---------------------------------

<div class="paragraph">

</div>

Finally let's prove that this partial evaluator is correct!

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Reserved Notation</span> "c' '/'
pe\_st' '/' st '<span style="font-family: arial;">⇓</span>' st''"\
   (<span class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 40, <span class="id" type="var">pe\_st'</span>
<span class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39, <span class="id" type="var">st</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39).\
\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">pe\_ceval</span>\
   (<span class="id" type="var">c'</span>:<span class="id"
type="var">com</span>) (<span class="id" type="var">pe\_st'</span>:<span
class="id" type="var">pe\_state</span>) (<span class="id"
type="var">st</span>:<span class="id" type="var">state</span>) (<span
class="id" type="var">st''</span>:<span class="id"
type="var">state</span>) : <span class="id" type="keyword">Prop</span>
:=\
   | <span class="id" type="var">pe\_ceval\_intro</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st'</span>,\
     <span class="id" type="var">c'</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">pe\_override</span> <span class="id"
type="var">st'</span> <span class="id" type="var">pe\_st'</span> = <span
class="id" type="var">st''</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>\
   <span class="id" type="keyword">where</span> "c' '/' pe\_st' '/' st
'<span style="font-family: arial;">⇓</span>' st''" := (<span class="id"
type="var">pe\_ceval</span> <span class="id" type="var">c'</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">st</span> <span class="id" type="var">st''</span>).\
\
 <span class="id" type="keyword">Hint</span> <span class="id"
type="var">Constructors</span> <span class="id"
type="var">pe\_ceval</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_com\_complete</span>:\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">c</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">c'</span>, <span class="id" type="var">c</span> / <span
class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c'</span> / <span class="id" type="var">pe\_st'</span> <span
style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st''</span>,\
   (<span class="id" type="var">c</span> / <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>) <span style="font-family: arial;">→</span>\
   (<span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">pe\_st'</span> <span class="id" type="var">c'</span> <span
class="id" type="var">Hpe</span>.\
   <span class="id" type="var">pe\_com\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">Hpe</span>)
<span class="id" type="var">Case</span>; <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">st''</span> <span class="id"
type="var">Heval</span>;\
   <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>;\
        <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">pe\_bexp\_correct</span>, <span
style="font-family: arial;">→</span> <span class="id"
type="var">H</span> <span class="id" type="keyword">in</span> ×; <span
class="id" type="var">solve</span> <span class="id"
type="tactic">by</span> <span class="id"
type="tactic">inversion</span>);\
        []);\
   <span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_AssStatic". <span
class="id" type="var">econstructor</span>. <span class="id"
type="var">econstructor</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">←</span>
<span class="id" type="var">pe\_override\_update\_add</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "PE\_AssDynamic". <span
class="id" type="var">econstructor</span>. <span class="id"
type="var">econstructor</span>. <span class="id"
type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">←</span>
<span class="id" type="var">pe\_override\_update\_remove</span>.\
     <span class="id" type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "PE\_Seq".\
     <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span>. <span class="id"
type="var">eassumption</span>. <span class="id"
type="tactic">subst</span>.\
     <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
     <span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_If". <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E'IfTrue". <span
class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="var">econstructor</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_IfTrue</span>.
<span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_Seq</span>. <span class="id"
type="var">eassumption</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="var">eassumption</span>.\
     <span class="id" type="var">SCase</span> "E\_IfFalse". <span
class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="var">econstructor</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">E\_IfFalse</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">←</span>
<span class="id" type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_Seq</span>. <span class="id"
type="var">eassumption</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_compare\_override</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="var">eassumption</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_com\_sound</span>:\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">c</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">c'</span>, <span class="id" type="var">c</span> / <span
class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c'</span> / <span class="id" type="var">pe\_st'</span> <span
style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st''</span>,\
   (<span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>) <span style="font-family: arial;">→</span>\
   (<span class="id" type="var">c</span> / <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">pe\_st'</span> <span class="id" type="var">c'</span> <span
class="id" type="var">Hpe</span>.\
   <span class="id" type="var">pe\_com\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">Hpe</span>)
<span class="id" type="var">Case</span>;\
     <span class="id" type="tactic">intros</span> <span class="id"
type="var">st</span> <span class="id" type="var">st''</span> [<span
class="id" type="var">st'</span> <span class="id"
type="var">Heval</span> <span class="id" type="var">Heq</span>];\
     <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
[]; <span class="id" type="tactic">subst</span>); <span class="id"
type="tactic">auto</span>.\
   <span class="id" type="var">Case</span> "PE\_AssStatic". <span
class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_override\_update\_add</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_Ass</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "PE\_AssDynamic". <span
class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_override\_update\_remove</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_Ass</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "PE\_Seq". <span class="id"
type="tactic">eapply</span> <span class="id" type="var">E\_Seq</span>;
<span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_IfTrue". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfTrue</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_IfFalse". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfFalse</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_If".\
     <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Heval</span>; <span class="id" type="tactic">subst</span>;
<span class="id" type="tactic">inversion</span> <span class="id"
type="var">H7</span>;\
       (<span class="id" type="tactic">eapply</span> <span class="id"
type="var">ceval\_deterministic</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H8</span>; [| <span
class="id" type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>]); <span class="id"
type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E\_IfTrue".\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfTrue</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="tactic">eauto</span>.\
     <span class="id" type="var">SCase</span> "E\_IfFalse".\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_compare\_override</span>.\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfFalse</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="tactic">eauto</span>.\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

The main theorem. Thanks to David Menendez for this formulation!

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Corollary</span> <span class="id"
type="var">pe\_com\_correct</span>:\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">c</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">c'</span>, <span class="id" type="var">c</span> / <span
class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c'</span> / <span class="id" type="var">pe\_st'</span> <span
style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st''</span>,\
   (<span class="id" type="var">c</span> / <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>) <span style="font-family: arial;">↔</span>\
   (<span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">pe\_st'</span> <span class="id" type="var">c'</span> <span
class="id" type="var">H</span> <span class="id" type="var">st</span>
<span class="id" type="var">st''</span>. <span class="id"
type="tactic">split</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">→</span>". <span class="id"
type="tactic">apply</span> <span class="id"
type="var">pe\_com\_complete</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">H</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">←</span>". <span class="id"
type="tactic">apply</span> <span class="id"
type="var">pe\_com\_sound</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">H</span>.\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Partial Evaluation of Loops {.section}
===========================

<div class="paragraph">

</div>

It may seem straightforward at first glance to extend the partial
evaluation relation <span class="inlinecode"><span class="id"
type="var">pe\_com</span></span> above to loops. Indeed, many loops are
easy to deal with. Considered this repeated-squaring loop, for example:
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">WHILE</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">ANum</span> 1) (<span
class="id" type="var">AId</span> <span class="id"
type="var">X</span>) <span class="id" type="var">DO</span>\
             <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>);;\
             <span class="id" type="var">X</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id"
type="var">ANum</span> 1)\
         <span class="id" type="var">END</span>
<div class="paragraph">

</div>

</div>

If we know neither <span class="inlinecode"><span class="id"
type="var">X</span></span> nor <span class="inlinecode"><span class="id"
type="var">Y</span></span> statically, then the entire loop is dynamic
and the residual command should be the same. If we know <span
class="inlinecode"><span class="id" type="var">X</span></span> but not
<span class="inlinecode"><span class="id" type="var">Y</span></span>,
then the loop can be unrolled all the way and the residual command
should be
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>);;\
         <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>);;\
         <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>)
<div class="paragraph">

</div>

</div>

if <span class="inlinecode"><span class="id" type="var">X</span></span>
is initially <span class="inlinecode">3</span> (and finally <span
class="inlinecode">0</span>). In general, a loop is easy to partially
evaluate if the final partial state of the loop body is equal to the
initial state, or if its guard condition is static.
<div class="paragraph">

</div>

But there are other loops for which it is hard to express the residual
program we want in Imp. For example, take this program for checking if
<span class="inlinecode"><span class="id" type="var">Y</span></span> is
even or odd:
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 0;;\
         <span class="id" type="var">WHILE</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">ANum</span> 1) (<span
class="id" type="var">AId</span> <span class="id"
type="var">Y</span>) <span class="id" type="var">DO</span>\
             <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">ANum</span> 1);;\
             <span class="id" type="var">X</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id"
type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>)\
         <span class="id" type="var">END</span>
<div class="paragraph">

</div>

</div>

The value of <span class="inlinecode"><span class="id"
type="var">X</span></span> alternates between <span
class="inlinecode">0</span> and <span class="inlinecode">1</span> during
the loop. Ideally, we would like to unroll this loop, not all the way
but *two-fold*, into something like
<div class="paragraph">

</div>

<div class="code code-tight">

        <span class="id" type="var">WHILE</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">ANum</span> 1) (<span
class="id" type="var">AId</span> <span class="id"
type="var">Y</span>) <span class="id" type="var">DO</span>\
             <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id"
type="var">ANum</span> 1);;\
             <span class="id" type="var">IF</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">ANum</span> 1) (<span
class="id" type="var">AId</span> <span class="id"
type="var">Y</span>) <span class="id" type="var">THEN</span>\
                 <span class="id" type="var">Y</span> ::= <span
class="id" type="var">AMinus</span> (<span class="id"
type="var">AId</span> <span class="id" type="var">Y</span>) (<span
class="id" type="var">ANum</span> 1)\
             <span class="id" type="var">ELSE</span>\
                 <span class="id" type="var">X</span> ::= <span
class="id" type="var">ANum</span> 1;; <span class="id"
type="var">EXIT</span>\
             <span class="id" type="var">FI</span>\
         <span class="id" type="var">END</span>;;\
         <span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 0
<div class="paragraph">

</div>

</div>

Unfortunately, there is no <span class="inlinecode"><span class="id"
type="var">EXIT</span></span> command in Imp. Without extending the
range of control structures available in our language, the best we can
do is to repeat loop-guard tests or add flag variables. Neither option
is terribly attractive.
<div class="paragraph">

</div>

Still, as a digression, below is an attempt at performing partial
evaluation on Imp commands. We add one more command argument <span
class="inlinecode"><span class="id" type="var">c''</span></span> to the
<span class="inlinecode"><span class="id"
type="var">pe\_com</span></span> relation, which keeps track of a loop
to roll up.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Module</span> <span class="id"
type="var">Loop</span>.\
\
 <span class="id" type="keyword">Reserved Notation</span> "c1 '/' st
'<span style="font-family: arial;">⇓</span>' c1' '/' st' '/' c''"\
   (<span class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 40, <span class="id" type="var">st</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39, <span class="id" type="var">c1'</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39, <span class="id" type="var">st'</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39).\
\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">pe\_com</span> : <span class="id" type="var">com</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_state</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">com</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_state</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">com</span> <span
style="font-family: arial;">→</span> <span class="id"
type="keyword">Prop</span> :=\
   | <span class="id" type="var">PE\_Skip</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span>,\
       <span class="id" type="var">SKIP</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">SKIP</span> / <span class="id"
type="var">pe\_st</span> / <span class="id" type="var">SKIP</span>\
   | <span class="id" type="var">PE\_AssStatic</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> <span
class="id" type="var">n1</span> <span class="id" type="var">l</span>,\
       <span class="id" type="var">pe\_aexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> = <span
class="id" type="var">ANum</span> <span class="id" type="var">n1</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">l</span> ::= <span class="id"
type="var">a1</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">SKIP</span> / <span class="id" type="var">pe\_add</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">l</span> <span class="id" type="var">n1</span> / <span
class="id" type="var">SKIP</span>\
   | <span class="id" type="var">PE\_AssDynamic</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> <span
class="id" type="var">a1'</span> <span class="id" type="var">l</span>,\
       <span class="id" type="var">pe\_aexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">a1</span> = <span
class="id" type="var">a1'</span> <span
style="font-family: arial;">→</span>\
       (<span style="font-family: arial;">∀</span><span class="id"
type="var">n</span>, <span class="id" type="var">a1'</span> ≠ <span
class="id" type="var">ANum</span> <span class="id" type="var">n</span>)
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">l</span> ::= <span class="id"
type="var">a1</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> (<span class="id"
type="var">l</span> ::= <span class="id" type="var">a1'</span>) / <span
class="id" type="var">pe\_remove</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">l</span> / <span
class="id" type="var">SKIP</span>\
   | <span class="id" type="var">PE\_Seq</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">pe\_st''</span> <span class="id"
type="var">c1</span> <span class="id" type="var">c2</span> <span
class="id" type="var">c1'</span> <span class="id" type="var">c2'</span>
<span class="id" type="var">c''</span>,\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">SKIP</span>
<span style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">pe\_st'</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c2'</span> / <span class="id"
type="var">pe\_st''</span> / <span class="id" type="var">c''</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">c1</span> ;; <span class="id"
type="var">c2</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> (<span class="id"
type="var">c1'</span> ;; <span class="id" type="var">c2'</span>) / <span
class="id" type="var">pe\_st''</span> / <span class="id"
type="var">c''</span>\
   | <span class="id" type="var">PE\_IfTrue</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">b1</span> <span class="id"
type="var">c1</span> <span class="id" type="var">c2</span> <span
class="id" type="var">c1'</span> <span class="id"
type="var">c''</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c1'</span> / <span class="id" type="var">pe\_st'</span> /
<span class="id" type="var">c''</span>\
   | <span class="id" type="var">PE\_IfFalse</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">b1</span> <span class="id"
type="var">c1</span> <span class="id" type="var">c2</span> <span
class="id" type="var">c2'</span> <span class="id"
type="var">c''</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c2'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c2'</span> / <span class="id" type="var">pe\_st'</span> /
<span class="id" type="var">c''</span>\
   | <span class="id" type="var">PE\_If</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">b1</span> <span class="id" type="var">c1</span> <span
class="id" type="var">c2</span> <span class="id" type="var">c1'</span>
<span class="id" type="var">c2'</span> <span class="id"
type="var">c''</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st1</span> / <span class="id" type="var">c''</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c2'</span> / <span class="id"
type="var">pe\_st2</span> / <span class="id" type="var">c''</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">pe\_st</span>\
         <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">IFB</span> <span class="id" type="var">pe\_bexp</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">b1</span>\
              <span class="id" type="var">THEN</span> <span class="id"
type="var">c1'</span> ;; <span class="id" type="var">assign</span> <span
class="id" type="var">pe\_st1</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>)\
              <span class="id" type="var">ELSE</span> <span class="id"
type="var">c2'</span> ;; <span class="id" type="var">assign</span> <span
class="id" type="var">pe\_st2</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>) <span class="id"
type="var">FI</span>)\
             / <span class="id" type="var">pe\_removes</span> <span
class="id" type="var">pe\_st1</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span>)\
             / <span class="id" type="var">c''</span>\
   | <span class="id" type="var">PE\_WhileEnd</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> <span
class="id" type="var">c1</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">SKIP</span> / <span class="id" type="var">pe\_st</span> /
<span class="id" type="var">SKIP</span>\
   | <span class="id" type="var">PE\_WhileLoop</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">pe\_st''</span> <span class="id"
type="var">b1</span> <span class="id" type="var">c1</span> <span
class="id" type="var">c1'</span> <span class="id" type="var">c2'</span>
<span class="id" type="var">c2''</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">SKIP</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st'</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c2'</span> / <span class="id" type="var">pe\_st''</span> /
<span class="id" type="var">c2''</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st''</span> ≠
[] <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> (<span class="id"
type="var">c1'</span>;;<span class="id" type="var">c2'</span>) / <span
class="id" type="var">pe\_st''</span> / <span class="id"
type="var">c2''</span>\
   | <span class="id" type="var">PE\_While</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">pe\_st''</span> <span class="id"
type="var">b1</span> <span class="id" type="var">c1</span> <span
class="id" type="var">c1'</span> <span class="id" type="var">c2'</span>
<span class="id" type="var">c2''</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">SKIP</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st'</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c2'</span> / <span class="id" type="var">pe\_st''</span> /
<span class="id" type="var">c2''</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st''</span> ≠
[] <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">c2''</span> = <span class="id"
type="var">SKIP</span> <span style="font-family: arial;">∨</span> <span
class="id" type="var">c2''</span> = <span class="id"
type="var">WHILE</span> <span class="id" type="var">b1</span> <span
class="id" type="var">DO</span> <span class="id" type="var">c1</span>
<span class="id" type="var">END</span>) <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st</span>\
         <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">IFB</span> <span class="id" type="var">pe\_bexp</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">b1</span>\
              <span class="id" type="var">THEN</span> <span class="id"
type="var">c1'</span>;; <span class="id" type="var">c2'</span>;; <span
class="id" type="var">assign</span> <span class="id"
type="var">pe\_st''</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">pe\_st''</span>)\
              <span class="id" type="var">ELSE</span> <span class="id"
type="var">assign</span> <span class="id" type="var">pe\_st</span>
(<span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st''</span>)
<span class="id" type="var">FI</span>)\
             / <span class="id" type="var">pe\_removes</span> <span
class="id" type="var">pe\_st</span> (<span class="id"
type="var">pe\_compare</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">pe\_st''</span>)\
             / <span class="id" type="var">c2''</span>\
   | <span class="id" type="var">PE\_WhileFixedEnd</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> <span
class="id" type="var">c1</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">SKIP</span> / <span class="id" type="var">pe\_st</span> /
(<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)\
   | <span class="id" type="var">PE\_WhileFixedLoop</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">pe\_st''</span> <span class="id"
type="var">b1</span> <span class="id" type="var">c1</span> <span
class="id" type="var">c1'</span> <span class="id"
type="var">c2'</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">SKIP</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st'</span>\
         <span style="font-family: arial;">⇓</span> <span class="id"
type="var">c2'</span> / <span class="id" type="var">pe\_st''</span> /
(<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
<span style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st''</span> =
[] <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st</span>\
         <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">WHILE</span> <span class="id" type="var">BTrue</span> <span
class="id" type="var">DO</span> <span class="id" type="var">SKIP</span>
<span class="id" type="var">END</span>) / <span class="id"
type="var">pe\_st</span> / <span class="id" type="var">SKIP</span>\
       <span
class="comment">(\* Because we have an infinite loop, we should actually\
          start to throw away the rest of the program:\
          (WHILE b1 DO c1 END) / pe\_st\
          || SKIP / pe\_st / (WHILE BTrue DO SKIP END) \*)</span>\
   | <span class="id" type="var">PE\_WhileFixed</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st'</span>
<span class="id" type="var">pe\_st''</span> <span class="id"
type="var">b1</span> <span class="id" type="var">c1</span> <span
class="id" type="var">c1'</span> <span class="id"
type="var">c2'</span>,\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BFalse</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b1</span> ≠ <span
class="id" type="var">BTrue</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c1'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">SKIP</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st'</span>\
         <span style="font-family: arial;">⇓</span> <span class="id"
type="var">c2'</span> / <span class="id" type="var">pe\_st''</span> /
(<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
<span style="font-family: arial;">→</span>\
       <span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">pe\_st''</span> =
[] <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">pe\_st</span>\
         <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">WHILE</span> <span class="id" type="var">pe\_bexp</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1'</span>;; <span class="id"
type="var">c2'</span> <span class="id" type="var">END</span>) / <span
class="id" type="var">pe\_st</span> / <span class="id"
type="var">SKIP</span>\
\
   <span class="id" type="keyword">where</span> "c1 '/' st '<span
style="font-family: arial;">⇓</span>' c1' '/' st' '/' c''" := (<span
class="id" type="var">pe\_com</span> <span class="id"
type="var">c1</span> <span class="id" type="var">st</span> <span
class="id" type="var">c1'</span> <span class="id" type="var">st'</span>
<span class="id" type="var">c''</span>).\
\
 <span class="id" type="keyword">Tactic Notation</span> "pe\_com\_cases"
<span class="id" type="var">tactic</span>(<span class="id"
type="var">first</span>) <span class="id" type="var">ident</span>(<span
class="id" type="var">c</span>) :=\
   <span class="id" type="var">first</span>;\
   [ <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_Skip"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_AssStatic" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"PE\_AssDynamic"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_Seq"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_IfTrue" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"PE\_IfFalse" | <span class="id" type="var">Case\_aux</span> <span
class="id" type="var">c</span> "PE\_If"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_WhileEnd" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"PE\_WhileLoop"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_While" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"PE\_WhileFixedEnd"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "PE\_WhileFixedLoop" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"PE\_WhileFixed" ].\
\
 <span class="id" type="keyword">Hint</span> <span class="id"
type="var">Constructors</span> <span class="id"
type="var">pe\_com</span>.\
\

</div>

<div class="doc">

Examples {.section}
--------

</div>

<div class="code code-space">

\
 <span class="id" type="keyword">Ltac</span> <span class="id"
type="var">step</span> <span class="id" type="var">i</span> :=\
   (<span class="id" type="tactic">eapply</span> <span class="id"
type="var">i</span>; <span class="id" type="tactic">intuition</span>
<span class="id" type="tactic">eauto</span>; <span class="id"
type="tactic">try</span> <span class="id" type="var">solve</span> <span
class="id" type="tactic">by</span> <span class="id"
type="tactic">inversion</span>);\
   <span class="id" type="tactic">repeat</span> (<span class="id"
type="tactic">try</span> <span class="id" type="tactic">eapply</span>
<span class="id" type="var">PE\_Seq</span>;\
           <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">eapply</span> <span class="id"
type="var">PE\_AssStatic</span>; <span class="id"
type="tactic">simpl</span>; <span class="id"
type="tactic">reflexivity</span>);\
           <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">eapply</span> <span class="id"
type="var">PE\_AssDynamic</span>;\
                [ <span class="id" type="tactic">simpl</span>; <span
class="id" type="tactic">reflexivity</span>\
                | <span class="id" type="tactic">intuition</span> <span
class="id" type="tactic">eauto</span>; <span class="id"
type="var">solve</span> <span class="id" type="tactic">by</span> <span
class="id" type="tactic">inversion</span> ])).\
\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">square\_loop</span>: <span class="id" type="var">com</span>
:=\
   <span class="id" type="var">WHILE</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">ANum</span> 1) (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
<span class="id" type="var">DO</span>\
     <span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id" type="var">AId</span>
<span class="id" type="var">Y</span>);;\
     <span class="id" type="var">X</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id" type="var">ANum</span>
1)\
   <span class="id" type="var">END</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_loop\_example1</span>:\
   <span class="id" type="var">square\_loop</span> / []\
   <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">WHILE</span> <span class="id" type="var">BLe</span> (<span
class="id" type="var">ANum</span> 1) (<span class="id"
type="var">AId</span> <span class="id" type="var">X</span>) <span
class="id" type="var">DO</span>\
          (<span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id" type="var">AId</span>
<span class="id" type="var">Y</span>);;\
           <span class="id" type="var">X</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id" type="var">ANum</span>
1));; <span class="id" type="var">SKIP</span>\
        <span class="id" type="var">END</span>) / [] / <span class="id"
type="var">SKIP</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="var">erewrite</span> <span class="id" type="var">f\_equal2</span>
<span class="id" type="keyword">with</span> (<span class="id"
type="var">f</span> := <span class="id" type="keyword">fun</span> <span
class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒
<span class="id" type="var">\_</span> / <span class="id"
type="var">\_</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">c</span> / <span class="id" type="var">st</span> /
<span class="id" type="var">SKIP</span>).\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileFixed</span>. <span class="id"
type="var">step</span> <span class="id"
type="var">PE\_WhileFixedEnd</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_loop\_example2</span>:\
   (<span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">square\_loop</span>) / []\
   <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">SKIP</span>;;\
        (<span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id" type="var">AId</span>
<span class="id" type="var">Y</span>);; <span class="id"
type="var">SKIP</span>);;\
        (<span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id" type="var">AId</span>
<span class="id" type="var">Y</span>);; <span class="id"
type="var">SKIP</span>);;\
        (<span class="id" type="var">Y</span> ::= <span class="id"
type="var">AMult</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>) (<span class="id" type="var">AId</span>
<span class="id" type="var">Y</span>);; <span class="id"
type="var">SKIP</span>);;\
        <span class="id" type="var">SKIP</span>) / [(<span class="id"
type="var">X</span>,0)] / <span class="id" type="var">SKIP</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="var">erewrite</span> <span class="id" type="var">f\_equal2</span>
<span class="id" type="keyword">with</span> (<span class="id"
type="var">f</span> := <span class="id" type="keyword">fun</span> <span
class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒
<span class="id" type="var">\_</span> / <span class="id"
type="var">\_</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">c</span> / <span class="id" type="var">st</span> /
<span class="id" type="var">SKIP</span>).\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_Seq</span>. <span class="id" type="tactic">eapply</span>
<span class="id" type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileLoop</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileLoop</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileLoop</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileEnd</span>.\
   <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">inversion</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>.\
   <span class="id" type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_loop\_example3</span>:\
   (<span class="id" type="var">Z</span> ::= <span class="id"
type="var">ANum</span> 3;; <span class="id"
type="var">subtract\_slowly</span>) / []\
   <span style="font-family: arial;">⇓</span> (<span class="id"
type="var">SKIP</span>;;\
        <span class="id" type="var">IFB</span> <span class="id"
type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
(<span class="id" type="var">ANum</span> 0)) <span class="id"
type="var">THEN</span>\
          (<span class="id" type="var">SKIP</span>;; <span class="id"
type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
(<span class="id" type="var">ANum</span> 1));;\
          <span class="id" type="var">IFB</span> <span class="id"
type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
(<span class="id" type="var">ANum</span> 0)) <span class="id"
type="var">THEN</span>\
            (<span class="id" type="var">SKIP</span>;; <span class="id"
type="var">X</span> ::= <span class="id" type="var">AMinus</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
(<span class="id" type="var">ANum</span> 1));;\
            <span class="id" type="var">IFB</span> <span class="id"
type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
(<span class="id" type="var">ANum</span> 0)) <span class="id"
type="var">THEN</span>\
              (<span class="id" type="var">SKIP</span>;; <span
class="id" type="var">X</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id" type="var">ANum</span>
1));;\
              <span class="id" type="var">WHILE</span> <span class="id"
type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">X</span>)
(<span class="id" type="var">ANum</span> 0)) <span class="id"
type="var">DO</span>\
                (<span class="id" type="var">SKIP</span>;; <span
class="id" type="var">X</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id" type="var">ANum</span>
1));; <span class="id" type="var">SKIP</span>\
              <span class="id" type="var">END</span>;;\
              <span class="id" type="var">SKIP</span>;; <span class="id"
type="var">Z</span> ::= <span class="id" type="var">ANum</span> 0\
            <span class="id" type="var">ELSE</span> <span class="id"
type="var">SKIP</span>;; <span class="id" type="var">Z</span> ::= <span
class="id" type="var">ANum</span> 1 <span class="id"
type="var">FI</span>;; <span class="id" type="var">SKIP</span>\
          <span class="id" type="var">ELSE</span> <span class="id"
type="var">SKIP</span>;; <span class="id" type="var">Z</span> ::= <span
class="id" type="var">ANum</span> 2 <span class="id"
type="var">FI</span>;; <span class="id" type="var">SKIP</span>\
        <span class="id" type="var">ELSE</span> <span class="id"
type="var">SKIP</span>;; <span class="id" type="var">Z</span> ::= <span
class="id" type="var">ANum</span> 3 <span class="id"
type="var">FI</span>) / [] / <span class="id" type="var">SKIP</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="var">erewrite</span> <span class="id" type="var">f\_equal2</span>
<span class="id" type="keyword">with</span> (<span class="id"
type="var">f</span> := <span class="id" type="keyword">fun</span> <span
class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒
<span class="id" type="var">\_</span> / <span class="id"
type="var">\_</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">c</span> / <span class="id" type="var">st</span> /
<span class="id" type="var">SKIP</span>).\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_Seq</span>. <span class="id" type="tactic">eapply</span>
<span class="id" type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_While</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_While</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_While</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileFixed</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileFixedEnd</span>.\
   <span class="id" type="tactic">reflexivity</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>.
<span class="id" type="tactic">inversion</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">inversion</span>
<span class="id" type="var">H</span>.\
   <span class="id" type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_loop\_example4</span>:\
   (<span class="id" type="var">X</span> ::= <span class="id"
type="var">ANum</span> 0;;\
    <span class="id" type="var">WHILE</span> <span class="id"
type="var">BLe</span> (<span class="id" type="var">AId</span> <span
class="id" type="var">X</span>) (<span class="id" type="var">ANum</span>
2) <span class="id" type="var">DO</span>\
      <span class="id" type="var">X</span> ::= <span class="id"
type="var">AMinus</span> (<span class="id" type="var">ANum</span> 1)
(<span class="id" type="var">AId</span> <span class="id"
type="var">X</span>)\
    <span class="id" type="var">END</span>) / [] <span
style="font-family: arial;">⇓</span> (<span class="id"
type="var">SKIP</span>;; <span class="id" type="var">WHILE</span> <span
class="id" type="var">BTrue</span> <span class="id" type="var">DO</span>
<span class="id" type="var">SKIP</span> <span class="id"
type="var">END</span>) / [(<span class="id" type="var">X</span>,0)] /
<span class="id" type="var">SKIP</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="var">erewrite</span> <span class="id" type="var">f\_equal2</span>
<span class="id" type="keyword">with</span> (<span class="id"
type="var">f</span> := <span class="id" type="keyword">fun</span> <span
class="id" type="var">c</span> <span class="id" type="var">st</span> ⇒
<span class="id" type="var">\_</span> / <span class="id"
type="var">\_</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">c</span> / <span class="id" type="var">st</span> /
<span class="id" type="var">SKIP</span>).\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">PE\_Seq</span>. <span class="id" type="tactic">eapply</span>
<span class="id" type="var">PE\_AssStatic</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileFixedLoop</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileLoop</span>.\
   <span class="id" type="var">step</span> <span class="id"
type="var">PE\_WhileFixedEnd</span>.\
   <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.
<span class="id" type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Correctness {.section}
-----------

<div class="paragraph">

</div>

Because this partial evaluator can unroll a loop n-fold where n is a
(finite) integer greater than one, in order to show it correct we need
to perform induction not structurally on dynamic evaluation but on the
number of times dynamic evaluation enters a loop body.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Reserved Notation</span> "c1 '/' st
'<span style="font-family: arial;">⇓</span>' st' '\#' n"\
   (<span class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 40, <span class="id" type="var">st</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39, <span class="id" type="var">st'</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39).\
\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">ceval\_count</span> : <span class="id" type="var">com</span>
<span style="font-family: arial;">→</span> <span class="id"
type="var">state</span> <span style="font-family: arial;">→</span> <span
class="id" type="var">state</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">nat</span> <span style="font-family: arial;">→</span> <span
class="id" type="keyword">Prop</span> :=\
   | <span class="id" type="var">E'Skip</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span>,\
       <span class="id" type="var">SKIP</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st</span> \# 0\
   | <span class="id" type="var">E'Ass</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">a1</span> <span
class="id" type="var">n</span> <span class="id" type="var">l</span>,\
       <span class="id" type="var">aeval</span> <span class="id"
type="var">st</span> <span class="id" type="var">a1</span> = <span
class="id" type="var">n</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">l</span> ::= <span class="id"
type="var">a1</span>) / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> (<span class="id"
type="var">update</span> <span class="id" type="var">st</span> <span
class="id" type="var">l</span> <span class="id" type="var">n</span>) \#
0\
   | <span class="id" type="var">E'Seq</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">c1</span> <span class="id" type="var">c2</span> <span
class="id" type="var">st</span> <span class="id" type="var">st'</span>
<span class="id" type="var">st''</span> <span class="id"
type="var">n1</span> <span class="id" type="var">n2</span>,\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> \# <span class="id"
type="var">n1</span> <span style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">st'</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st''</span> \# <span class="id"
type="var">n2</span> <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">c1</span> ;; <span class="id"
type="var">c2</span>) / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# (<span class="id" type="var">n1</span> + <span
class="id" type="var">n2</span>)\
   | <span class="id" type="var">E'IfTrue</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st'</span> <span
class="id" type="var">b1</span> <span class="id" type="var">c1</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">n</span>,\
       <span class="id" type="var">beval</span> <span class="id"
type="var">st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">true</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> \# <span class="id" type="var">n</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st'</span> \# <span class="id" type="var">n</span>\
   | <span class="id" type="var">E'IfFalse</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st'</span> <span
class="id" type="var">b1</span> <span class="id" type="var">c1</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">n</span>,\
       <span class="id" type="var">beval</span> <span class="id"
type="var">st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">false</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c2</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> \# <span class="id" type="var">n</span>
<span style="font-family: arial;">→</span>\
       (<span class="id" type="var">IFB</span> <span class="id"
type="var">b1</span> <span class="id" type="var">THEN</span> <span
class="id" type="var">c1</span> <span class="id" type="var">ELSE</span>
<span class="id" type="var">c2</span> <span class="id"
type="var">FI</span>) / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st'</span> \# <span class="id" type="var">n</span>\
   | <span class="id" type="var">E'WhileEnd</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">b1</span> <span class="id" type="var">st</span> <span
class="id" type="var">c1</span>,\
       <span class="id" type="var">beval</span> <span class="id"
type="var">st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">false</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st</span> \# 0\
   | <span class="id" type="var">E'WhileLoop</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st'</span> <span
class="id" type="var">st''</span> <span class="id" type="var">b1</span>
<span class="id" type="var">c1</span> <span class="id"
type="var">n1</span> <span class="id" type="var">n2</span>,\
       <span class="id" type="var">beval</span> <span class="id"
type="var">st</span> <span class="id" type="var">b1</span> = <span
class="id" type="var">true</span> <span
style="font-family: arial;">→</span>\
       <span class="id" type="var">c1</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> \# <span class="id"
type="var">n1</span> <span style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">st'</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n2</span> <span
style="font-family: arial;">→</span>\
       (<span class="id" type="var">WHILE</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1</span> <span class="id" type="var">END</span>)
/ <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">S</span> (<span
class="id" type="var">n1</span> + <span class="id"
type="var">n2</span>)\
\
   <span class="id" type="keyword">where</span> "c1 '/' st '<span
style="font-family: arial;">⇓</span>' st' \# n" := (<span class="id"
type="var">ceval\_count</span> <span class="id" type="var">c1</span>
<span class="id" type="var">st</span> <span class="id"
type="var">st'</span> <span class="id" type="var">n</span>).\
\
 <span class="id" type="keyword">Tactic Notation</span>
"ceval\_count\_cases" <span class="id" type="var">tactic</span>(<span
class="id" type="var">first</span>) <span class="id"
type="var">ident</span>(<span class="id" type="var">c</span>) :=\
   <span class="id" type="var">first</span>;\
   [ <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "E'Skip" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span> "E'Ass"
| <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "E'Seq"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "E'IfTrue" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"E'IfFalse"\
   | <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "E'WhileEnd" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"E'WhileLoop" ].\
\
 <span class="id" type="keyword">Hint</span> <span class="id"
type="var">Constructors</span> <span class="id"
type="var">ceval\_count</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">ceval\_count\_complete</span>: <span
style="font-family: arial;">∀</span><span class="id" type="var">c</span>
<span class="id" type="var">st</span> <span class="id"
type="var">st'</span>,\
   <span class="id" type="var">c</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> <span
style="font-family: arial;">→</span> <span
style="font-family: arial;">∃</span><span class="id"
type="var">n</span>, <span class="id" type="var">c</span> / <span
class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st'</span> \# <span class="id" type="var">n</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">st</span> <span class="id" type="var">st'</span>
<span class="id" type="var">Heval</span>.\
   <span class="id" type="tactic">induction</span> <span class="id"
type="var">Heval</span>;\
     <span class="id" type="tactic">try</span> <span class="id"
type="tactic">inversion</span> <span class="id"
type="var">IHHeval1</span>;\
     <span class="id" type="tactic">try</span> <span class="id"
type="tactic">inversion</span> <span class="id"
type="var">IHHeval2</span>;\
     <span class="id" type="tactic">try</span> <span class="id"
type="tactic">inversion</span> <span class="id"
type="var">IHHeval</span>;\
     <span class="id" type="tactic">eauto</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">ceval\_count\_sound</span>: <span
style="font-family: arial;">∀</span><span class="id" type="var">c</span>
<span class="id" type="var">st</span> <span class="id"
type="var">st'</span> <span class="id" type="var">n</span>,\
   <span class="id" type="var">c</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> \# <span class="id" type="var">n</span>
<span style="font-family: arial;">→</span> <span class="id"
type="var">c</span> / <span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st'</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">st</span> <span class="id" type="var">st'</span>
<span class="id" type="var">n</span> <span class="id"
type="var">Heval</span>. <span class="id" type="tactic">induction</span>
<span class="id" type="var">Heval</span>; <span class="id"
type="tactic">eauto</span>. <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_compare\_nil\_lookup</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>,\
   <span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span> =
[] <span style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">V</span>, <span class="id" type="var">pe\_lookup</span> <span
class="id" type="var">pe\_st1</span> <span class="id"
type="var">V</span> = <span class="id" type="var">pe\_lookup</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">V</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">H</span> <span class="id" type="var">V</span>.\
   <span class="id" type="tactic">apply</span> (<span class="id"
type="var">pe\_compare\_correct</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>
<span class="id" type="var">V</span>).\
   <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">intro</span>. <span
class="id" type="tactic">inversion</span> <span class="id"
type="var">H0</span>. <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_compare\_nil\_override</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span>,\
   <span class="id" type="var">pe\_compare</span> <span class="id"
type="var">pe\_st1</span> <span class="id" type="var">pe\_st2</span> =
[] <span style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">st</span>, <span class="id" type="var">pe\_override</span>
<span class="id" type="var">st</span> <span class="id"
type="var">pe\_st1</span> = <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st2</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">pe\_st1</span>
<span class="id" type="var">pe\_st2</span> <span class="id"
type="var">H</span> <span class="id" type="var">st</span>.\
   <span class="id" type="tactic">apply</span> <span class="id"
type="var">functional\_extensionality</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">V</span>.\
   <span class="id" type="tactic">rewrite</span> !<span class="id"
type="var">pe\_override\_correct</span>.\
   <span class="id" type="tactic">apply</span> <span class="id"
type="var">pe\_compare\_nil\_lookup</span> <span class="id"
type="keyword">with</span> (<span class="id" type="var">V</span>:=<span
class="id" type="var">V</span>) <span class="id"
type="keyword">in</span> <span class="id" type="var">H</span>.\
   <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">reflexivity</span>.
<span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Reserved Notation</span> "c' '/'
pe\_st' '/' c'' '/' st '<span style="font-family: arial;">⇓</span>' st''
'\#' n"\
   (<span class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 40, <span class="id" type="var">pe\_st'</span>
<span class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39, <span class="id" type="var">c''</span> <span
class="id" type="tactic">at</span> <span class="id"
type="var">level</span> 39,\
    <span class="id" type="var">st</span> <span class="id"
type="tactic">at</span> <span class="id" type="var">level</span> 39,
<span class="id" type="var">st''</span> <span class="id"
type="tactic">at</span> <span class="id" type="var">level</span> 39).\
\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">pe\_ceval\_count</span> (<span class="id"
type="var">c'</span>:<span class="id" type="var">com</span>) (<span
class="id" type="var">pe\_st'</span>:<span class="id"
type="var">pe\_state</span>) (<span class="id"
type="var">c''</span>:<span class="id" type="var">com</span>)\
                          (<span class="id" type="var">st</span>:<span
class="id" type="var">state</span>) (<span class="id"
type="var">st''</span>:<span class="id" type="var">state</span>) (<span
class="id" type="var">n</span>:<span class="id" type="var">nat</span>) :
<span class="id" type="keyword">Prop</span> :=\
   | <span class="id" type="var">pe\_ceval\_count\_intro</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st'</span> <span class="id" type="var">n'</span>,\
     <span class="id" type="var">c'</span> / <span class="id"
type="var">st</span> <span style="font-family: arial;">⇓</span> <span
class="id" type="var">st'</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">c''</span> / <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st'</span>
<span class="id" type="var">pe\_st'</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n'</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">n'</span> ≤ <span class="id"
type="var">n</span> <span style="font-family: arial;">→</span>\
     <span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> /
<span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n</span>\
   <span class="id" type="keyword">where</span> "c' '/' pe\_st' '/' c''
'/' st '<span style="font-family: arial;">⇓</span>' st'' '\#' n" :=\
         (<span class="id" type="var">pe\_ceval\_count</span> <span
class="id" type="var">c'</span> <span class="id"
type="var">pe\_st'</span> <span class="id" type="var">c''</span> <span
class="id" type="var">st</span> <span class="id" type="var">st''</span>
<span class="id" type="var">n</span>).\
\
 <span class="id" type="keyword">Hint</span> <span class="id"
type="var">Constructors</span> <span class="id"
type="var">pe\_ceval\_count</span>.\
\
 <span class="id" type="keyword">Lemma</span> <span class="id"
type="var">pe\_ceval\_count\_le</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">c'</span> <span class="id" type="var">pe\_st'</span> <span
class="id" type="var">c''</span> <span class="id" type="var">st</span>
<span class="id" type="var">st''</span> <span class="id"
type="var">n</span> <span class="id" type="var">n'</span>,\
   <span class="id" type="var">n'</span> ≤ <span class="id"
type="var">n</span> <span style="font-family: arial;">→</span>\
   <span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> /
<span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n'</span> <span
style="font-family: arial;">→</span>\
   <span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> /
<span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c'</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">c''</span> <span class="id" type="var">st</span> <span
class="id" type="var">st''</span> <span class="id" type="var">n</span>
<span class="id" type="var">n'</span> <span class="id"
type="var">Hle</span> <span class="id" type="var">H</span>. <span
class="id" type="tactic">inversion</span> <span class="id"
type="var">H</span>.\
   <span class="id" type="var">econstructor</span>; <span class="id"
type="tactic">try</span> <span class="id" type="var">eassumption</span>.
<span class="id" type="tactic">omega</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_com\_complete</span>:\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">c</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">c'</span> <span class="id" type="var">c''</span>, <span
class="id" type="var">c</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> <span
style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st''</span> <span
class="id" type="var">n</span>,\
   (<span class="id" type="var">c</span> / <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n</span>) <span
style="font-family: arial;">→</span>\
   (<span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> /
<span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">pe\_st'</span> <span class="id" type="var">c'</span> <span
class="id" type="var">c''</span> <span class="id"
type="var">Hpe</span>.\
   <span class="id" type="var">pe\_com\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">Hpe</span>)
<span class="id" type="var">Case</span>; <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">st''</span> <span class="id" type="var">n</span>
<span class="id" type="var">Heval</span>;\
   <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>;\
        <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">pe\_bexp\_correct</span>, <span
style="font-family: arial;">→</span> <span class="id"
type="var">H</span> <span class="id" type="keyword">in</span> ×; <span
class="id" type="var">solve</span> <span class="id"
type="tactic">by</span> <span class="id"
type="tactic">inversion</span>);\
        []);\
   <span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_AssStatic". <span
class="id" type="var">econstructor</span>. <span class="id"
type="var">econstructor</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">←</span>
<span class="id" type="var">pe\_override\_update\_add</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">H</span>. <span class="id" type="tactic">apply</span> <span
class="id" type="var">E'Skip</span>. <span class="id"
type="tactic">auto</span>.\
   <span class="id" type="var">Case</span> "PE\_AssDynamic". <span
class="id" type="var">econstructor</span>. <span class="id"
type="var">econstructor</span>. <span class="id"
type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">←</span>
<span class="id" type="var">pe\_override\_update\_remove</span>.\
     <span class="id" type="tactic">apply</span> <span class="id"
type="var">E'Skip</span>. <span class="id" type="tactic">auto</span>.\
   <span class="id" type="var">Case</span> "PE\_Seq".\
     <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ?
? <span class="id" type="var">Hskip</span> ?]. <span class="id"
type="var">eassumption</span>.\
     <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
     <span class="id" type="var">econstructor</span>; <span class="id"
type="tactic">eauto</span>. <span class="id"
type="tactic">omega</span>.\
   <span class="id" type="var">Case</span> "PE\_If". <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E'IfTrue". <span
class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="var">econstructor</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_IfTrue</span>.
<span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_Seq</span>. <span class="id"
type="var">eassumption</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="var">eassumption</span>. <span class="id"
type="var">eassumption</span>.\
     <span class="id" type="var">SCase</span> "E\_IfFalse". <span
class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="var">econstructor</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">E\_IfFalse</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">←</span>
<span class="id" type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_Seq</span>. <span class="id"
type="var">eassumption</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_compare\_override</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="var">eassumption</span>. <span class="id"
type="var">eassumption</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileLoop".\
     <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ?
? <span class="id" type="var">Hskip</span> ?]. <span class="id"
type="var">eassumption</span>.\
     <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
     <span class="id" type="var">econstructor</span>; <span class="id"
type="tactic">eauto</span>. <span class="id"
type="tactic">omega</span>.\
   <span class="id" type="var">Case</span> "PE\_While". <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E\_WhileEnd". <span
class="id" type="var">econstructor</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">E\_IfFalse</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H2</span>;
<span class="id" type="tactic">subst</span>; <span class="id"
type="tactic">auto</span>.\
       <span class="id" type="tactic">auto</span>.\
     <span class="id" type="var">SCase</span> "E\_WhileLoop".\
       <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ?
? <span class="id" type="var">Hskip</span> ?]. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.\
       <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="var">econstructor</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">E\_IfTrue</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">repeat</span> <span class="id"
type="tactic">eapply</span> <span class="id" type="var">E\_Seq</span>;
<span class="id" type="tactic">eauto</span>. <span class="id"
type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_compare\_override</span>, <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="tactic">omega</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileFixedLoop". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">ex\_falso\_quodlibet</span>.\
     <span class="id" type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> (<span class="id" type="var">S</span>
(<span class="id" type="var">n1</span> + <span class="id"
type="var">n2</span>)). <span class="id" type="tactic">intros</span>
<span class="id" type="var">n</span>.\
     <span class="id" type="tactic">clear</span> - <span class="id"
type="var">Case</span> <span class="id" type="var">H</span> <span
class="id" type="var">H0</span> <span class="id"
type="var">IHHpe1</span> <span class="id" type="var">IHHpe2</span>.
<span class="id" type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id" type="var">st</span>.\
     <span class="id" type="tactic">induction</span> <span class="id"
type="var">n</span> <span class="id" type="keyword">using</span> <span
class="id" type="var">lt\_wf\_ind</span>; <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">Heval</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E'WhileEnd". <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">pe\_bexp\_correct</span>, <span class="id"
type="var">H</span> <span class="id" type="keyword">in</span> <span
class="id" type="var">H7</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H7</span>.\
     <span class="id" type="var">SCase</span> "E'WhileLoop".\
       <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ?
? <span class="id" type="var">Hskip</span> ?]. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.\
       <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> (<span class="id"
type="var">pe\_compare\_nil\_override</span> <span class="id"
type="var">\_</span> <span class="id" type="var">\_</span> <span
class="id" type="var">H0</span>) <span class="id"
type="keyword">in</span> <span class="id" type="var">H7</span>.\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">H1</span> <span class="id" type="keyword">in</span> <span
class="id" type="var">H7</span>; [| <span class="id"
type="tactic">omega</span>]. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H7</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileFixed". <span
class="id" type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id" type="var">st</span>.\
     <span class="id" type="tactic">induction</span> <span class="id"
type="var">n</span> <span class="id" type="keyword">using</span> <span
class="id" type="var">lt\_wf\_ind</span>; <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">Heval</span>. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E'WhileEnd". <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">pe\_bexp\_correct</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H8</span>. <span
class="id" type="tactic">eauto</span>.\
     <span class="id" type="var">SCase</span> "E'WhileLoop". <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">pe\_bexp\_correct</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H5</span>.\
       <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe1</span> <span class="id" type="keyword">as</span> [? ?
? <span class="id" type="var">Hskip</span> ?]. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Hskip</span>. <span class="id" type="tactic">subst</span>.\
       <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> (<span class="id"
type="var">pe\_compare\_nil\_override</span> <span class="id"
type="var">\_</span> <span class="id" type="var">\_</span> <span
class="id" type="var">H1</span>) <span class="id"
type="keyword">in</span> <span class="id" type="var">H8</span>.\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">H2</span> <span class="id" type="keyword">in</span> <span
class="id" type="var">H8</span>; [| <span class="id"
type="tactic">omega</span>]. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H8</span>.\
       <span class="id" type="var">econstructor</span>; [ <span
class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_WhileLoop</span>; <span class="id"
type="tactic">eauto</span> | <span class="id"
type="var">eassumption</span> | <span class="id"
type="tactic">omega</span>].\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_com\_sound</span>:\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">c</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">c'</span> <span class="id" type="var">c''</span>, <span
class="id" type="var">c</span> / <span class="id"
type="var">pe\_st</span> <span style="font-family: arial;">⇓</span>
<span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> <span
style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st''</span> <span
class="id" type="var">n</span>,\
   (<span class="id" type="var">c'</span> / <span class="id"
type="var">pe\_st'</span> / <span class="id" type="var">c''</span> /
<span class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span> \# <span class="id" type="var">n</span>) <span
style="font-family: arial;">→</span>\
   (<span class="id" type="var">c</span> / <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">pe\_st'</span> <span class="id" type="var">c'</span> <span
class="id" type="var">c''</span> <span class="id"
type="var">Hpe</span>.\
   <span class="id" type="var">pe\_com\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">Hpe</span>)
<span class="id" type="var">Case</span>;\
     <span class="id" type="tactic">intros</span> <span class="id"
type="var">st</span> <span class="id" type="var">st''</span> <span
class="id" type="var">n</span> [<span class="id" type="var">st'</span>
<span class="id" type="var">n'</span> <span class="id"
type="var">Heval</span> <span class="id" type="var">Heval'</span> <span
class="id" type="var">Hle</span>];\
     <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
[]; <span class="id" type="tactic">subst</span>);\
     <span class="id" type="tactic">try</span> (<span class="id"
type="tactic">inversion</span> <span class="id"
type="var">Heval'</span>; []; <span class="id"
type="tactic">subst</span>); <span class="id"
type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_AssStatic". <span
class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_override\_update\_add</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_Ass</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "PE\_AssDynamic". <span
class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_override\_update\_remove</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_Ass</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">pe\_aexp\_correct</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "PE\_Seq". <span class="id"
type="tactic">eapply</span> <span class="id" type="var">E\_Seq</span>;
<span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_IfTrue". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfTrue</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe</span>. <span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_IfFalse". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfFalse</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe</span>. <span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_If". <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>; <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H7</span>;
<span class="id" type="tactic">subst</span>; <span class="id"
type="tactic">clear</span> <span class="id" type="var">H7</span>.\
     <span class="id" type="var">SCase</span> "E\_IfTrue".\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">ceval\_deterministic</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H8</span>; [| <span
class="id" type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>]. <span class="id"
type="tactic">subst</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval'</span>.\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfTrue</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe1</span>. <span class="id" type="tactic">eauto</span>.\
     <span class="id" type="var">SCase</span> "E\_IfFalse".\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">ceval\_deterministic</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H8</span>; [| <span
class="id" type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>]. <span class="id"
type="tactic">subst</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_compare\_override</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval'</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval'</span>.\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">E\_IfFalse</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe2</span>. <span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileEnd". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">E\_WhileEnd</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileLoop". <span
class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_WhileLoop</span>.\
     <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">H</span>. <span class="id"
type="tactic">reflexivity</span>.\
     <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe1</span>. <span class="id" type="tactic">eauto</span>.
<span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe2</span>. <span class="id" type="tactic">eauto</span>.\
   <span class="id" type="var">Case</span> "PE\_While". <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Heval</span>;
<span class="id" type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E\_IfTrue".\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H9</span>. <span class="id" type="tactic">subst</span>. <span
class="id" type="tactic">clear</span> <span class="id"
type="var">H9</span>.\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H10</span>. <span class="id" type="tactic">subst</span>.
<span class="id" type="tactic">clear</span> <span class="id"
type="var">H10</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">ceval\_deterministic</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H11</span>; [|
<span class="id" type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>]. <span class="id"
type="tactic">subst</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_compare\_override</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval'</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval'</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_WhileLoop</span>. <span class="id"
type="tactic">rewrite</span> <span style="font-family: arial;">→</span>
<span class="id" type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe1</span>. <span class="id" type="tactic">eauto</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe2</span>. <span class="id" type="tactic">eauto</span>.\
     <span class="id" type="var">SCase</span> "E\_IfFalse". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">ceval\_count\_sound</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval'</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">ceval\_deterministic</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H9</span>; [| <span
class="id" type="tactic">apply</span> <span class="id"
type="var">eval\_assign</span>]. <span class="id"
type="tactic">subst</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> <span class="id"
type="var">assign\_removes</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval'</span>.\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H2</span>; <span class="id" type="tactic">subst</span>.\
       <span class="id" type="var">SSCase</span> "c2'' = SKIP". <span
class="id" type="tactic">inversion</span> <span class="id"
type="var">Heval'</span>. <span class="id" type="tactic">subst</span>.
<span class="id" type="tactic">apply</span> <span class="id"
type="var">E\_WhileEnd</span>.\
         <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
       <span class="id" type="var">SSCase</span> "c2'' = WHILE b1 DO c1
END". <span class="id" type="tactic">assumption</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileFixedEnd". <span
class="id" type="tactic">eapply</span> <span class="id"
type="var">ceval\_count\_sound</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">Heval'</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileFixedLoop".\
     <span class="id" type="tactic">apply</span> <span class="id"
type="var">loop\_never\_stops</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval</span>. <span
class="id" type="tactic">inversion</span> <span class="id"
type="var">Heval</span>.\
   <span class="id" type="var">Case</span> "PE\_WhileFixed".\
     <span class="id" type="tactic">clear</span> - <span class="id"
type="var">Case</span> <span class="id" type="var">H1</span> <span
class="id" type="var">IHHpe1</span> <span class="id"
type="var">IHHpe2</span> <span class="id" type="var">Heval</span>.\
     <span class="id" type="var">remember</span> (<span class="id"
type="var">WHILE</span> <span class="id" type="var">pe\_bexp</span>
<span class="id" type="var">pe\_st</span> <span class="id"
type="var">b1</span> <span class="id" type="var">DO</span> <span
class="id" type="var">c1'</span>;; <span class="id"
type="var">c2'</span> <span class="id" type="var">END</span>) <span
class="id" type="keyword">as</span> <span class="id"
type="var">c'</span>.\
     <span class="id" type="var">ceval\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">Heval</span>)
<span class="id" type="var">SCase</span>;\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Heqc'</span>; <span class="id" type="tactic">subst</span>;
<span class="id" type="tactic">clear</span> <span class="id"
type="var">Heqc'</span>.\
     <span class="id" type="var">SCase</span> "E\_WhileEnd". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">E\_WhileEnd</span>.\
       <span class="id" type="tactic">rewrite</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>.\
     <span class="id" type="var">SCase</span> "E\_WhileLoop".\
       <span class="id" type="tactic">assert</span> (<span class="id"
type="var">IHHeval2'</span> := <span class="id"
type="var">IHHeval2</span> (<span class="id"
type="var">refl\_equal</span> <span class="id" type="var">\_</span>)).\
       <span class="id" type="tactic">apply</span> <span class="id"
type="var">ceval\_count\_complete</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">IHHeval2'</span>.
<span class="id" type="tactic">inversion</span> <span class="id"
type="var">IHHeval2'</span>.\
       <span class="id" type="tactic">clear</span> <span class="id"
type="var">IHHeval1</span> <span class="id" type="var">IHHeval2</span>
<span class="id" type="var">IHHeval2'</span>.\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Heval1</span>. <span class="id" type="tactic">subst</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_WhileLoop</span>. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_bexp\_correct</span>. <span class="id"
type="tactic">assumption</span>. <span class="id"
type="tactic">eauto</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">IHHpe2</span>. <span class="id"
type="var">econstructor</span>. <span class="id"
type="var">eassumption</span>.\
       <span class="id" type="tactic">rewrite</span> <span
style="font-family: arial;">←</span> (<span class="id"
type="var">pe\_compare\_nil\_override</span> <span class="id"
type="var">\_</span> <span class="id" type="var">\_</span> <span
class="id" type="var">H1</span>). <span class="id"
type="var">eassumption</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">le\_n</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Corollary</span> <span class="id"
type="var">pe\_com\_correct</span>:\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">c</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">pe\_st'</span> <span class="id"
type="var">c'</span>, <span class="id" type="var">c</span> / <span
class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">c'</span> / <span class="id" type="var">pe\_st'</span> /
<span class="id" type="var">SKIP</span> <span
style="font-family: arial;">→</span>\
   <span style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">st''</span>,\
   (<span class="id" type="var">c</span> / <span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st''</span>) <span style="font-family: arial;">↔</span>\
   (<span style="font-family: arial;">∃</span><span class="id"
type="var">st'</span>, <span class="id" type="var">c'</span> / <span
class="id" type="var">st</span> <span
style="font-family: arial;">⇓</span> <span class="id"
type="var">st'</span> <span style="font-family: arial;">∧</span> <span
class="id" type="var">pe\_override</span> <span class="id"
type="var">st'</span> <span class="id" type="var">pe\_st'</span> = <span
class="id" type="var">st''</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">c</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">pe\_st'</span> <span class="id" type="var">c'</span> <span
class="id" type="var">H</span> <span class="id" type="var">st</span>
<span class="id" type="var">st''</span>. <span class="id"
type="tactic">split</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">→</span>". <span class="id"
type="tactic">intros</span> <span class="id" type="var">Heval</span>.\
     <span class="id" type="tactic">apply</span> <span class="id"
type="var">ceval\_count\_complete</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heval</span>. <span
class="id" type="tactic">inversion</span> <span class="id"
type="var">Heval</span> <span class="id" type="keyword">as</span> [<span
class="id" type="var">n</span> <span class="id"
type="var">Heval'</span>].\
     <span class="id" type="tactic">apply</span> <span class="id"
type="var">pe\_com\_complete</span> <span class="id"
type="keyword">with</span> (<span class="id" type="var">st</span>:=<span
class="id" type="var">st</span>) (<span class="id"
type="var">st''</span>:=<span class="id" type="var">st''</span>) (<span
class="id" type="var">n</span>:=<span class="id" type="var">n</span>)
<span class="id" type="keyword">in</span> <span class="id"
type="var">H</span>.\
     <span class="id" type="tactic">inversion</span> <span class="id"
type="var">H</span> <span class="id" type="keyword">as</span> [? ? ?
<span class="id" type="var">Hskip</span> ?]. <span class="id"
type="tactic">inversion</span> <span class="id" type="var">Hskip</span>.
<span class="id" type="tactic">subst</span>. <span class="id"
type="tactic">eauto</span>.\
     <span class="id" type="tactic">assumption</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">←</span>". <span class="id"
type="tactic">intros</span> [<span class="id" type="var">st'</span>
[<span class="id" type="var">Heval</span> <span class="id"
type="var">Heq</span>]]. <span class="id" type="tactic">subst</span>
<span class="id" type="var">st''</span>.\
     <span class="id" type="tactic">eapply</span> <span class="id"
type="var">pe\_com\_sound</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">H</span>. <span
class="id" type="tactic">apply</span> <span class="id"
type="var">H</span>.\
     <span class="id" type="var">econstructor</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">Heval</span>.
<span class="id" type="tactic">apply</span> <span class="id"
type="var">E'Skip</span>. <span class="id" type="tactic">apply</span>
<span class="id" type="var">le\_n</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">End</span> <span class="id"
type="var">Loop</span>.\
\

</div>

<div class="doc">

Partial Evaluation of Flowchart Programs {.section}
========================================

<div class="paragraph">

</div>

Instead of partially evaluating <span class="inlinecode"><span
class="id" type="var">WHILE</span></span> loops directly, the standard
approach to partially evaluating imperative programs is to convert them
into *flowcharts*. In other words, it turns out that adding labels and
jumps to our language makes it much easier to partially evaluate. The
result of partially evaluating a flowchart is a residual flowchart. If
we are lucky, the jumps in the residual flowchart can be converted back
to <span class="inlinecode"><span class="id"
type="var">WHILE</span></span> loops, but that is not possible in
general; we do not pursue it here.
<div class="paragraph">

</div>

Basic blocks {.section}
------------

<div class="paragraph">

</div>

A flowchart is made of *basic blocks*, which we represent with the
inductive type <span class="inlinecode"><span class="id"
type="var">block</span></span>. A basic block is a sequence of
assignments (the constructor <span class="inlinecode"><span class="id"
type="var">Assign</span></span>), concluding with a conditional jump
(the constructor <span class="inlinecode"><span class="id"
type="var">If</span></span>) or an unconditional jump (the constructor
<span class="inlinecode"><span class="id"
type="var">Goto</span></span>). The destinations of the jumps are
specified by *labels*, which can be of any type. Therefore, we
parameterize the <span class="inlinecode"><span class="id"
type="var">block</span></span> type by the type of labels.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">block</span> (<span class="id" type="var">Label</span>:<span
class="id" type="keyword">Type</span>) : <span class="id"
type="keyword">Type</span> :=\
   | <span class="id" type="var">Goto</span> : <span class="id"
type="var">Label</span> <span style="font-family: arial;">→</span> <span
class="id" type="var">block</span> <span class="id"
type="var">Label</span>\
   | <span class="id" type="var">If</span> : <span class="id"
type="var">bexp</span> <span style="font-family: arial;">→</span> <span
class="id" type="var">Label</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">Label</span> <span style="font-family: arial;">→</span> <span
class="id" type="var">block</span> <span class="id"
type="var">Label</span>\
   | <span class="id" type="var">Assign</span> : <span class="id"
type="var">id</span> <span style="font-family: arial;">→</span> <span
class="id" type="var">aexp</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">block</span> <span class="id" type="var">Label</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">block</span> <span class="id" type="var">Label</span>.\
\
 <span class="id" type="keyword">Tactic Notation</span> "block\_cases"
<span class="id" type="var">tactic</span>(<span class="id"
type="var">first</span>) <span class="id" type="var">ident</span>(<span
class="id" type="var">c</span>) :=\
   <span class="id" type="var">first</span>;\
   [ <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "Goto" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span> "If" |
<span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "Assign" ].\
\
 <span class="id" type="var">Arguments</span> <span class="id"
type="var">Goto</span> {<span class="id" type="var">Label</span>} <span
class="id" type="var">\_</span>.\
 <span class="id" type="var">Arguments</span> <span class="id"
type="var">If</span> {<span class="id" type="var">Label</span>} <span
class="id" type="var">\_</span> <span class="id" type="var">\_</span>
<span class="id" type="var">\_</span>.\
 <span class="id" type="var">Arguments</span> <span class="id"
type="var">Assign</span> {<span class="id" type="var">Label</span>}
<span class="id" type="var">\_</span> <span class="id"
type="var">\_</span> <span class="id" type="var">\_</span>.\
\

</div>

<div class="doc">

We use the "even or odd" program, expressed above in Imp, as our running
example. Converting this program into a flowchart turns out to require 4
labels, so we define the following type.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">parity\_label</span> : <span class="id"
type="keyword">Type</span> :=\
   | <span class="id" type="var">entry</span> : <span class="id"
type="var">parity\_label</span>\
   | <span class="id" type="var">loop</span> : <span class="id"
type="var">parity\_label</span>\
   | <span class="id" type="var">body</span> : <span class="id"
type="var">parity\_label</span>\
   | <span class="id" type="var">done</span> : <span class="id"
type="var">parity\_label</span>.\
\

</div>

<div class="doc">

The following <span class="inlinecode"><span class="id"
type="var">block</span></span> is the basic block found at the <span
class="inlinecode"><span class="id" type="var">body</span></span> label
of the example program.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">parity\_body</span> : <span class="id"
type="var">block</span> <span class="id" type="var">parity\_label</span>
:=\
   <span class="id" type="var">Assign</span> <span class="id"
type="var">Y</span> (<span class="id" type="var">AMinus</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">Y</span>)
(<span class="id" type="var">ANum</span> 1))\
    (<span class="id" type="var">Assign</span> <span class="id"
type="var">X</span> (<span class="id" type="var">AMinus</span> (<span
class="id" type="var">ANum</span> 1) (<span class="id"
type="var">AId</span> <span class="id" type="var">X</span>))\
      (<span class="id" type="var">Goto</span> <span class="id"
type="var">loop</span>)).\
\

</div>

<div class="doc">

To evaluate a basic block, given an initial state, is to compute the
final state and the label to jump to next. Because basic blocks do not
*contain* loops or other control structures, evaluation of basic blocks
is a total function — we don't need to worry about non-termination.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">keval</span> {<span class="id" type="var">L</span>:<span
class="id" type="keyword">Type</span>} (<span class="id"
type="var">st</span>:<span class="id" type="var">state</span>) (<span
class="id" type="var">k</span> : <span class="id"
type="var">block</span> <span class="id" type="var">L</span>) : <span
class="id" type="var">state</span> × <span class="id"
type="var">L</span> :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">k</span> <span class="id" type="keyword">with</span>\
   | <span class="id" type="var">Goto</span> <span class="id"
type="var">l</span> ⇒ (<span class="id" type="var">st</span>, <span
class="id" type="var">l</span>)\
   | <span class="id" type="var">If</span> <span class="id"
type="var">b</span> <span class="id" type="var">l1</span> <span
class="id" type="var">l2</span> ⇒ (<span class="id"
type="var">st</span>, <span class="id" type="keyword">if</span> <span
class="id" type="var">beval</span> <span class="id" type="var">st</span>
<span class="id" type="var">b</span> <span class="id"
type="keyword">then</span> <span class="id" type="var">l1</span> <span
class="id" type="keyword">else</span> <span class="id"
type="var">l2</span>)\
   | <span class="id" type="var">Assign</span> <span class="id"
type="var">i</span> <span class="id" type="var">a</span> <span
class="id" type="var">k</span> ⇒ <span class="id"
type="var">keval</span> (<span class="id" type="var">update</span> <span
class="id" type="var">st</span> <span class="id" type="var">i</span>
(<span class="id" type="var">aeval</span> <span class="id"
type="var">st</span> <span class="id" type="var">a</span>)) <span
class="id" type="var">k</span>\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">keval\_example</span>:\
   <span class="id" type="var">keval</span> <span class="id"
type="var">empty\_state</span> <span class="id"
type="var">parity\_body</span>\
   = (<span class="id" type="var">update</span> (<span class="id"
type="var">update</span> <span class="id" type="var">empty\_state</span>
<span class="id" type="var">Y</span> 0) <span class="id"
type="var">X</span> 1, <span class="id" type="var">loop</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\

</div>

<div class="doc">

Flowchart programs {.section}
------------------

<div class="paragraph">

</div>

A flowchart program is simply a lookup function that maps labels to
basic blocks. Actually, some labels are *halting states* and do not map
to any basic block. So, more precisely, a flowchart <span
class="inlinecode"><span class="id" type="var">program</span></span>
whose labels are of type <span class="inlinecode"><span class="id"
type="var">L</span></span> is a function from <span
class="inlinecode"><span class="id" type="var">L</span></span> to <span
class="inlinecode"><span class="id" type="var">option</span></span>
<span class="inlinecode">(<span class="id"
type="var">block</span></span> <span class="inlinecode"><span class="id"
type="var">L</span>)</span>.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">program</span> (<span class="id" type="var">L</span>:<span
class="id" type="keyword">Type</span>) : <span class="id"
type="keyword">Type</span> := <span class="id" type="var">L</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">option</span> (<span class="id" type="var">block</span> <span
class="id" type="var">L</span>).\
\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">parity</span> : <span class="id" type="var">program</span>
<span class="id" type="var">parity\_label</span> := <span class="id"
type="keyword">fun</span> <span class="id" type="var">l</span> ⇒\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">l</span> <span class="id" type="keyword">with</span>\
   | <span class="id" type="var">entry</span> ⇒ <span class="id"
type="var">Some</span> (<span class="id" type="var">Assign</span> <span
class="id" type="var">X</span> (<span class="id" type="var">ANum</span>
0) (<span class="id" type="var">Goto</span> <span class="id"
type="var">loop</span>))\
   | <span class="id" type="var">loop</span> ⇒ <span class="id"
type="var">Some</span> (<span class="id" type="var">If</span> (<span
class="id" type="var">BLe</span> (<span class="id"
type="var">ANum</span> 1) (<span class="id" type="var">AId</span> <span
class="id" type="var">Y</span>)) <span class="id" type="var">body</span>
<span class="id" type="var">done</span>)\
   | <span class="id" type="var">body</span> ⇒ <span class="id"
type="var">Some</span> <span class="id" type="var">parity\_body</span>\
   | <span class="id" type="var">done</span> ⇒ <span class="id"
type="var">None</span> <span class="comment">(\* halt \*)</span>\
   <span class="id" type="keyword">end</span>.\
\

</div>

<div class="doc">

Unlike a basic block, a program may not terminate, so we model the
evaluation of programs by an inductive relation <span
class="inlinecode"><span class="id" type="var">peval</span></span>
rather than a recursive function.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">peval</span> {<span class="id" type="var">L</span>:<span
class="id" type="keyword">Type</span>} (<span class="id"
type="var">p</span> : <span class="id" type="var">program</span> <span
class="id" type="var">L</span>)\
   : <span class="id" type="var">state</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">L</span> <span style="font-family: arial;">→</span> <span
class="id" type="var">state</span> <span
style="font-family: arial;">→</span> <span class="id"
type="var">L</span> <span style="font-family: arial;">→</span> <span
class="id" type="keyword">Prop</span> :=\
   | <span class="id" type="var">E\_None</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">l</span>,\
     <span class="id" type="var">p</span> <span class="id"
type="var">l</span> = <span class="id" type="var">None</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">peval</span> <span class="id"
type="var">p</span> <span class="id" type="var">st</span> <span
class="id" type="var">l</span> <span class="id" type="var">st</span>
<span class="id" type="var">l</span>\
   | <span class="id" type="var">E\_Some</span>: <span
style="font-family: arial;">∀</span><span class="id"
type="var">st</span> <span class="id" type="var">l</span> <span
class="id" type="var">k</span> <span class="id" type="var">st'</span>
<span class="id" type="var">l'</span> <span class="id"
type="var">st''</span> <span class="id" type="var">l''</span>,\
     <span class="id" type="var">p</span> <span class="id"
type="var">l</span> = <span class="id" type="var">Some</span> <span
class="id" type="var">k</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">keval</span> <span class="id"
type="var">st</span> <span class="id" type="var">k</span> = (<span
class="id" type="var">st'</span>, <span class="id" type="var">l'</span>)
<span style="font-family: arial;">→</span>\
     <span class="id" type="var">peval</span> <span class="id"
type="var">p</span> <span class="id" type="var">st'</span> <span
class="id" type="var">l'</span> <span class="id" type="var">st''</span>
<span class="id" type="var">l''</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">peval</span> <span class="id"
type="var">p</span> <span class="id" type="var">st</span> <span
class="id" type="var">l</span> <span class="id" type="var">st''</span>
<span class="id" type="var">l''</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">parity\_eval</span>: <span class="id" type="var">peval</span>
<span class="id" type="var">parity</span> <span class="id"
type="var">empty\_state</span> <span class="id" type="var">entry</span>
<span class="id" type="var">empty\_state</span> <span class="id"
type="var">done</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="var">erewrite</span> <span class="id"
type="tactic">f\_equal</span> <span class="id"
type="keyword">with</span> (<span class="id" type="var">f</span> :=
<span class="id" type="keyword">fun</span> <span class="id"
type="var">st</span> ⇒ <span class="id" type="var">peval</span> <span
class="id" type="var">\_</span> <span class="id" type="var">\_</span>
<span class="id" type="var">\_</span> <span class="id"
type="var">st</span> <span class="id" type="var">\_</span>).\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_Some</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_Some</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">apply</span> <span class="id"
type="var">E\_None</span>. <span class="id"
type="tactic">reflexivity</span>.\
   <span class="id" type="tactic">apply</span> <span class="id"
type="var">functional\_extensionality</span>. <span class="id"
type="tactic">intros</span> <span class="id" type="var">i</span>. <span
class="id" type="tactic">rewrite</span> <span class="id"
type="var">update\_same</span>; <span class="id"
type="tactic">auto</span>.\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Tactic Notation</span> "peval\_cases"
<span class="id" type="var">tactic</span>(<span class="id"
type="var">first</span>) <span class="id" type="var">ident</span>(<span
class="id" type="var">c</span>) :=\
   <span class="id" type="var">first</span>;\
   [ <span class="id" type="var">Case\_aux</span> <span class="id"
type="var">c</span> "E\_None" | <span class="id"
type="var">Case\_aux</span> <span class="id" type="var">c</span>
"E\_Some" ].\
\

</div>

<div class="doc">

Partial evaluation of basic blocks and flowchart programs {.section}
---------------------------------------------------------

<div class="paragraph">

</div>

Partial evaluation changes the label type in a systematic way: if the
label type used to be <span class="inlinecode"><span class="id"
type="var">L</span></span>, it becomes <span class="inlinecode"><span
class="id" type="var">pe\_state</span></span> <span
class="inlinecode">×</span> <span class="inlinecode"><span class="id"
type="var">L</span></span>. So the same label in the original program
may be unfolded, or blown up, into multiple labels by being paired with
different partial states. For example, the label <span
class="inlinecode"><span class="id" type="var">loop</span></span> in the
<span class="inlinecode"><span class="id"
type="var">parity</span></span> program will become two labels: <span
class="inlinecode">([(<span class="id" type="var">X</span>,0)],</span>
<span class="inlinecode"><span class="id" type="var">loop</span>)</span>
and <span class="inlinecode">([(<span class="id"
type="var">X</span>,1)],</span> <span class="inlinecode"><span
class="id" type="var">loop</span>)</span>. This change of label type is
reflected in the types of <span class="inlinecode"><span class="id"
type="var">pe\_block</span></span> and <span class="inlinecode"><span
class="id" type="var">pe\_program</span></span> defined presently.

</div>

<div class="code code-tight">

\
 <span class="id" type="keyword">Fixpoint</span> <span class="id"
type="var">pe\_block</span> {<span class="id" type="var">L</span>:<span
class="id" type="keyword">Type</span>} (<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">k</span> : <span class="id"
type="var">block</span> <span class="id" type="var">L</span>)\
   : <span class="id" type="var">block</span> (<span class="id"
type="var">pe\_state</span> × <span class="id" type="var">L</span>) :=\
   <span class="id" type="keyword">match</span> <span class="id"
type="var">k</span> <span class="id" type="keyword">with</span>\
   | <span class="id" type="var">Goto</span> <span class="id"
type="var">l</span> ⇒ <span class="id" type="var">Goto</span> (<span
class="id" type="var">pe\_st</span>, <span class="id"
type="var">l</span>)\
   | <span class="id" type="var">If</span> <span class="id"
type="var">b</span> <span class="id" type="var">l1</span> <span
class="id" type="var">l2</span> ⇒\
     <span class="id" type="keyword">match</span> <span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b</span> <span class="id"
type="keyword">with</span>\
     | <span class="id" type="var">BTrue</span> ⇒ <span class="id"
type="var">Goto</span> (<span class="id" type="var">pe\_st</span>, <span
class="id" type="var">l1</span>)\
     | <span class="id" type="var">BFalse</span> ⇒ <span class="id"
type="var">Goto</span> (<span class="id" type="var">pe\_st</span>, <span
class="id" type="var">l2</span>)\
     | <span class="id" type="var">b'</span> ⇒ <span class="id"
type="var">If</span> <span class="id" type="var">b'</span> (<span
class="id" type="var">pe\_st</span>, <span class="id"
type="var">l1</span>) (<span class="id" type="var">pe\_st</span>, <span
class="id" type="var">l2</span>)\
     <span class="id" type="keyword">end</span>\
   | <span class="id" type="var">Assign</span> <span class="id"
type="var">i</span> <span class="id" type="var">a</span> <span
class="id" type="var">k</span> ⇒\
     <span class="id" type="keyword">match</span> <span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a</span> <span class="id"
type="keyword">with</span>\
     | <span class="id" type="var">ANum</span> <span class="id"
type="var">n</span> ⇒ <span class="id" type="var">pe\_block</span>
(<span class="id" type="var">pe\_add</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">i</span> <span
class="id" type="var">n</span>) <span class="id" type="var">k</span>\
     | <span class="id" type="var">a'</span> ⇒ <span class="id"
type="var">Assign</span> <span class="id" type="var">i</span> <span
class="id" type="var">a'</span> (<span class="id"
type="var">pe\_block</span> (<span class="id"
type="var">pe\_remove</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">i</span>) <span class="id"
type="var">k</span>)\
     <span class="id" type="keyword">end</span>\
   <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Example</span> <span class="id"
type="var">pe\_block\_example</span>:\
   <span class="id" type="var">pe\_block</span> [(<span class="id"
type="var">X</span>,0)] <span class="id" type="var">parity\_body</span>\
   = <span class="id" type="var">Assign</span> <span class="id"
type="var">Y</span> (<span class="id" type="var">AMinus</span> (<span
class="id" type="var">AId</span> <span class="id" type="var">Y</span>)
(<span class="id" type="var">ANum</span> 1)) (<span class="id"
type="var">Goto</span> ([(<span class="id" type="var">X</span>,1)],
<span class="id" type="var">loop</span>)).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_block\_correct</span>: <span
style="font-family: arial;">∀</span>(<span class="id"
type="var">L</span>:<span class="id" type="keyword">Type</span>) <span
class="id" type="var">st</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">k</span> <span
class="id" type="var">st'</span> <span class="id"
type="var">pe\_st'</span> (<span class="id" type="var">l'</span>:<span
class="id" type="var">L</span>),\
   <span class="id" type="var">keval</span> <span class="id"
type="var">st</span> (<span class="id" type="var">pe\_block</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">k</span>) = (<span class="id" type="var">st'</span>, (<span
class="id" type="var">pe\_st'</span>, <span class="id"
type="var">l'</span>)) <span style="font-family: arial;">→</span>\
   <span class="id" type="var">keval</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="var">k</span> = (<span class="id" type="var">pe\_override</span>
<span class="id" type="var">st'</span> <span class="id"
type="var">pe\_st'</span>, <span class="id" type="var">l'</span>).\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span>. <span class="id"
type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id"
type="var">pe\_st</span>. <span class="id"
type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id" type="var">st</span>.\
   <span class="id" type="var">block\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">k</span>
<span class="id" type="keyword">as</span> [<span class="id"
type="var">l</span> | <span class="id" type="var">b</span> <span
class="id" type="var">l1</span> <span class="id" type="var">l2</span> |
<span class="id" type="var">i</span> <span class="id"
type="var">a</span> <span class="id" type="var">k</span>]) <span
class="id" type="var">Case</span>;\
     <span class="id" type="tactic">intros</span> <span class="id"
type="var">st</span> <span class="id" type="var">pe\_st</span> <span
class="id" type="var">H</span>.\
   <span class="id" type="var">Case</span> "Goto". <span class="id"
type="tactic">inversion</span> <span class="id" type="var">H</span>;
<span class="id" type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "If".\
     <span class="id" type="tactic">replace</span> (<span class="id"
type="var">keval</span> <span class="id" type="var">st</span> (<span
class="id" type="var">pe\_block</span> <span class="id"
type="var">pe\_st</span> (<span class="id" type="var">If</span> <span
class="id" type="var">b</span> <span class="id" type="var">l1</span>
<span class="id" type="var">l2</span>)))\
        <span class="id" type="keyword">with</span> (<span class="id"
type="var">keval</span> <span class="id" type="var">st</span> (<span
class="id" type="var">If</span> (<span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b</span>) (<span class="id"
type="var">pe\_st</span>, <span class="id" type="var">l1</span>) (<span
class="id" type="var">pe\_st</span>, <span class="id"
type="var">l2</span>)))\
        <span class="id" type="keyword">in</span> <span class="id"
type="var">H</span> <span class="id" type="tactic">by</span> (<span
class="id" type="tactic">simpl</span>; <span class="id"
type="tactic">destruct</span> (<span class="id"
type="var">pe\_bexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">b</span>); <span class="id"
type="tactic">reflexivity</span>).\
     <span class="id" type="tactic">simpl</span> <span class="id"
type="keyword">in</span> ×. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_bexp\_correct</span>.\
     <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">beval</span> <span class="id" type="var">st</span> (<span
class="id" type="var">pe\_bexp</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">b</span>)); <span
class="id" type="tactic">inversion</span> <span class="id"
type="var">H</span>; <span class="id" type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "Assign".\
     <span class="id" type="tactic">simpl</span> <span class="id"
type="keyword">in</span> ×. <span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_aexp\_correct</span>.\
     <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">pe\_aexp</span> <span class="id" type="var">pe\_st</span>
<span class="id" type="var">a</span>); <span class="id"
type="tactic">simpl</span>;\
       <span class="id" type="tactic">try</span> <span class="id"
type="var">solve</span> [<span class="id" type="tactic">rewrite</span>
<span class="id" type="var">pe\_override\_update\_add</span>; <span
class="id" type="tactic">apply</span> <span class="id"
type="var">IHk</span>; <span class="id" type="tactic">apply</span> <span
class="id" type="var">H</span>];\
       <span class="id" type="var">solve</span> [<span class="id"
type="tactic">rewrite</span> <span class="id"
type="var">pe\_override\_update\_remove</span>; <span class="id"
type="tactic">apply</span> <span class="id" type="var">IHk</span>; <span
class="id" type="tactic">apply</span> <span class="id"
type="var">H</span>].\
 <span class="id" type="keyword">Qed</span>.\
\
 <span class="id" type="keyword">Definition</span> <span class="id"
type="var">pe\_program</span> {<span class="id"
type="var">L</span>:<span class="id" type="keyword">Type</span>} (<span
class="id" type="var">p</span> : <span class="id"
type="var">program</span> <span class="id" type="var">L</span>)\
   : <span class="id" type="var">program</span> (<span class="id"
type="var">pe\_state</span> × <span class="id" type="var">L</span>) :=\
   <span class="id" type="keyword">fun</span> <span class="id"
type="var">pe\_l</span> ⇒ <span class="id" type="keyword">match</span>
<span class="id" type="var">pe\_l</span> <span class="id"
type="keyword">with</span> (<span class="id" type="var">pe\_st</span>,
<span class="id" type="var">l</span>) ⇒\
                 <span class="id" type="var">option\_map</span> (<span
class="id" type="var">pe\_block</span> <span class="id"
type="var">pe\_st</span>) (<span class="id" type="var">p</span> <span
class="id" type="var">l</span>)\
               <span class="id" type="keyword">end</span>.\
\
 <span class="id" type="keyword">Inductive</span> <span class="id"
type="var">pe\_peval</span> {<span class="id" type="var">L</span>:<span
class="id" type="keyword">Type</span>} (<span class="id"
type="var">p</span> : <span class="id" type="var">program</span> <span
class="id" type="var">L</span>)\
   (<span class="id" type="var">st</span>:<span class="id"
type="var">state</span>) (<span class="id"
type="var">pe\_st</span>:<span class="id" type="var">pe\_state</span>)
(<span class="id" type="var">l</span>:<span class="id"
type="var">L</span>) (<span class="id" type="var">st'o</span>:<span
class="id" type="var">state</span>) (<span class="id"
type="var">l'</span>:<span class="id" type="var">L</span>) : <span
class="id" type="keyword">Prop</span> :=\
   | <span class="id" type="var">pe\_peval\_intro</span> : <span
style="font-family: arial;">∀</span><span class="id"
type="var">st'</span> <span class="id" type="var">pe\_st'</span>,\
     <span class="id" type="var">peval</span> (<span class="id"
type="var">pe\_program</span> <span class="id" type="var">p</span>)
<span class="id" type="var">st</span> (<span class="id"
type="var">pe\_st</span>, <span class="id" type="var">l</span>) <span
class="id" type="var">st'</span> (<span class="id"
type="var">pe\_st'</span>, <span class="id" type="var">l'</span>) <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">pe\_override</span> <span class="id"
type="var">st'</span> <span class="id" type="var">pe\_st'</span> = <span
class="id" type="var">st'o</span> <span
style="font-family: arial;">→</span>\
     <span class="id" type="var">pe\_peval</span> <span class="id"
type="var">p</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">l</span>
<span class="id" type="var">st'o</span> <span class="id"
type="var">l'</span>.\
\
 <span class="id" type="keyword">Theorem</span> <span class="id"
type="var">pe\_program\_correct</span>:\
   <span style="font-family: arial;">∀</span>(<span class="id"
type="var">L</span>:<span class="id" type="keyword">Type</span>) (<span
class="id" type="var">p</span> : <span class="id"
type="var">program</span> <span class="id" type="var">L</span>) <span
class="id" type="var">st</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">l</span> <span
class="id" type="var">st'o</span> <span class="id"
type="var">l'</span>,\
   <span class="id" type="var">peval</span> <span class="id"
type="var">p</span> (<span class="id" type="var">pe\_override</span>
<span class="id" type="var">st</span> <span class="id"
type="var">pe\_st</span>) <span class="id" type="var">l</span> <span
class="id" type="var">st'o</span> <span class="id" type="var">l'</span>
<span style="font-family: arial;">↔</span>\
   <span class="id" type="var">pe\_peval</span> <span class="id"
type="var">p</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id" type="var">l</span>
<span class="id" type="var">st'o</span> <span class="id"
type="var">l'</span>.\
 <span class="id" type="keyword">Proof</span>. <span class="id"
type="tactic">intros</span>.\
   <span class="id" type="tactic">split</span>; [<span class="id"
type="var">Case</span> "<span style="font-family: arial;">→</span>" |
<span class="id" type="var">Case</span> "<span
style="font-family: arial;">←</span>"].\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">→</span>". <span class="id"
type="tactic">intros</span> <span class="id" type="var">Heval</span>.\
     <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_override</span> <span class="id" type="var">st</span>
<span class="id" type="var">pe\_st</span>) <span class="id"
type="keyword">as</span> <span class="id" type="var">sto</span>.\
     <span class="id" type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id"
type="var">pe\_st</span>. <span class="id"
type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id" type="var">st</span>.\
     <span class="id" type="var">peval\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">Heval</span>
<span class="id" type="keyword">as</span>\
       [ <span class="id" type="var">sto</span> <span class="id"
type="var">l</span> <span class="id" type="var">Hlookup</span> | <span
class="id" type="var">sto</span> <span class="id" type="var">l</span>
<span class="id" type="var">k</span> <span class="id"
type="var">st'o</span> <span class="id" type="var">l'</span> <span
class="id" type="var">st''o</span> <span class="id"
type="var">l''</span> <span class="id" type="var">Hlookup</span> <span
class="id" type="var">Hkeval</span> <span class="id"
type="var">Heval</span> ])\
       <span class="id" type="var">SCase</span>; <span class="id"
type="tactic">intros</span> <span class="id" type="var">st</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">Heqsto</span>; <span class="id" type="tactic">subst</span>
<span class="id" type="var">sto</span>.\
     <span class="id" type="var">SCase</span> "E\_None". <span
class="id" type="tactic">eapply</span> <span class="id"
type="var">pe\_peval\_intro</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">E\_None</span>.\
       <span class="id" type="tactic">simpl</span>. <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">Hlookup</span>.
<span class="id" type="tactic">reflexivity</span>. <span class="id"
type="tactic">reflexivity</span>.\
     <span class="id" type="var">SCase</span> "E\_Some".\
       <span class="id" type="var">remember</span> (<span class="id"
type="var">keval</span> <span class="id" type="var">st</span> (<span
class="id" type="var">pe\_block</span> <span class="id"
type="var">pe\_st</span> <span class="id" type="var">k</span>)) <span
class="id" type="keyword">as</span> <span class="id"
type="var">x</span>.\
       <span class="id" type="tactic">destruct</span> <span class="id"
type="var">x</span> <span class="id" type="keyword">as</span> [<span
class="id" type="var">st'</span> [<span class="id"
type="var">pe\_st'</span> <span class="id" type="var">l'\_</span>]].\
       <span class="id" type="tactic">symmetry</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Heqx</span>. <span
class="id" type="var">erewrite</span> <span class="id"
type="var">pe\_block\_correct</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Hkeval</span> <span
class="id" type="tactic">by</span> <span class="id"
type="tactic">apply</span> <span class="id" type="var">Heqx</span>.\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Hkeval</span>. <span class="id" type="tactic">subst</span>
<span class="id" type="var">st'o</span> <span class="id"
type="var">l'\_</span>. <span class="id" type="tactic">clear</span>
<span class="id" type="var">Hkeval</span>.\
       <span class="id" type="var">edestruct</span> <span class="id"
type="var">IHHeval</span>. <span class="id"
type="tactic">reflexivity</span>. <span class="id"
type="tactic">subst</span> <span class="id" type="var">st''o</span>.
<span class="id" type="tactic">clear</span> <span class="id"
type="var">IHHeval</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">pe\_peval\_intro</span>; [| <span class="id"
type="tactic">reflexivity</span>]. <span class="id"
type="tactic">eapply</span> <span class="id" type="var">E\_Some</span>;
<span class="id" type="tactic">eauto</span>.\
       <span class="id" type="tactic">simpl</span>. <span class="id"
type="tactic">rewrite</span> <span class="id" type="var">Hlookup</span>.
<span class="id" type="tactic">reflexivity</span>.\
   <span class="id" type="var">Case</span> "<span
style="font-family: arial;">←</span>". <span class="id"
type="tactic">intros</span> [<span class="id" type="var">st'</span>
<span class="id" type="var">pe\_st'</span> <span class="id"
type="var">Heval</span> <span class="id" type="var">Heqst'o</span>].\
     <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_st</span>, <span class="id" type="var">l</span>) <span
class="id" type="keyword">as</span> <span class="id"
type="var">pe\_st\_l</span>.\
     <span class="id" type="var">remember</span> (<span class="id"
type="var">pe\_st'</span>, <span class="id" type="var">l'</span>) <span
class="id" type="keyword">as</span> <span class="id"
type="var">pe\_st'\_l'</span>.\
     <span class="id" type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id"
type="var">pe\_st</span>. <span class="id"
type="tactic">generalize</span> <span class="id"
type="tactic">dependent</span> <span class="id" type="var">l</span>.\
     <span class="id" type="var">peval\_cases</span> (<span class="id"
type="tactic">induction</span> <span class="id" type="var">Heval</span>
<span class="id" type="keyword">as</span>\
       [ <span class="id" type="var">st</span> [<span class="id"
type="var">pe\_st\_</span> <span class="id" type="var">l\_</span>] <span
class="id" type="var">Hlookup</span>\
       | <span class="id" type="var">st</span> [<span class="id"
type="var">pe\_st\_</span> <span class="id" type="var">l\_</span>] <span
class="id" type="var">pe\_k</span> <span class="id"
type="var">st'</span> [<span class="id" type="var">pe\_st'\_</span>
<span class="id" type="var">l'\_</span>] <span class="id"
type="var">st''</span> [<span class="id" type="var">pe\_st''</span>
<span class="id" type="var">l''</span>]\
         <span class="id" type="var">Hlookup</span> <span class="id"
type="var">Hkeval</span> <span class="id" type="var">Heval</span> ])\
       <span class="id" type="var">SCase</span>; <span class="id"
type="tactic">intros</span> <span class="id" type="var">l</span> <span
class="id" type="var">pe\_st</span> <span class="id"
type="var">Heqpe\_st\_l</span>;\
       <span class="id" type="tactic">inversion</span> <span class="id"
type="var">Heqpe\_st\_l</span>; <span class="id"
type="tactic">inversion</span> <span class="id"
type="var">Heqpe\_st'\_l'</span>; <span class="id"
type="tactic">repeat</span> <span class="id"
type="tactic">subst</span>.\
     <span class="id" type="var">SCase</span> "E\_None". <span
class="id" type="tactic">apply</span> <span class="id"
type="var">E\_None</span>. <span class="id" type="tactic">simpl</span>
<span class="id" type="keyword">in</span> <span class="id"
type="var">Hlookup</span>.\
       <span class="id" type="tactic">destruct</span> (<span class="id"
type="var">p</span> <span class="id" type="var">l'</span>); [ <span
class="id" type="var">solve</span> [ <span class="id"
type="tactic">inversion</span> <span class="id"
type="var">Hlookup</span> ] | <span class="id"
type="tactic">reflexivity</span> ].\
     <span class="id" type="var">SCase</span> "E\_Some".\
       <span class="id" type="tactic">simpl</span> <span class="id"
type="keyword">in</span> <span class="id" type="var">Hlookup</span>.
<span class="id" type="var">remember</span> (<span class="id"
type="var">p</span> <span class="id" type="var">l</span>) <span
class="id" type="keyword">as</span> <span class="id"
type="var">k</span>.\
       <span class="id" type="tactic">destruct</span> <span class="id"
type="var">k</span> <span class="id" type="keyword">as</span> [<span
class="id" type="var">k</span>|]; <span class="id"
type="tactic">inversion</span> <span class="id"
type="var">Hlookup</span>; <span class="id" type="tactic">subst</span>.\
       <span class="id" type="tactic">eapply</span> <span class="id"
type="var">E\_Some</span>; <span class="id" type="tactic">eauto</span>.
<span class="id" type="tactic">apply</span> <span class="id"
type="var">pe\_block\_correct</span>. <span class="id"
type="tactic">apply</span> <span class="id" type="var">Hkeval</span>.\
 <span class="id" type="keyword">Qed</span>.\
\

</div>

<div class="doc">

</div>

<div class="code code-tight">

</div>

</div>

<div id="footer">

------------------------------------------------------------------------

[Index](http://www.cis.upenn.edu/~bcpierce/sf/current/coqindex.html)

</div>

</div>
